<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gauss-Seidel - Métodos Numéricos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'custom-blue': '#242A38', // Kept for header/footer consistency
                        'custom-red': '#E94560', // Main accent color
                        'custom-gray-bg': '#F3F4F6',
                        'sidebar-bg': '#FFFFFF',
                        'sidebar-text': '#4B5563',
                        'sidebar-hover-bg': '#FEF2F2', // Red-tinted hover for sidebar
                    }
                }
            }
        }
    </script>
    <script>
        window.MathJax = {
            tex: { packages: {'[+]': ['input/mml', 'output/chtml']} },
            chtml: { matchFontHeight: false },
            options: { ignoreHtmlClass: 'tex2jax_ignore', processHtmlClass: 'tex2jax_process' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @keyframes animatedRainbowBorder { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
        .animate-rainbow-border::before {
            content: ''; position: absolute; z-index: -1; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 9999px;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #007bff, #8a2be2, #ff00ff, #ff0000);
            background-size: 200% 100%;
            animation: animatedRainbowBorder 3s linear infinite;
        }
        .animate-rainbow-border { position: relative; z-index: 0; }
        .correct-answer-gs { border-color: #10B981; background-color: #D1FAE5; }
        .incorrect-answer-gs { border-color: #EF4444; background-color: #FEE2E2; }

        .gs-output-fullscreen {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            z-index: 9990 !important; background-color: #111827 !important;
            padding: 20px !important; margin: 0 !important; border-radius: 0 !important;
            overflow-y: auto !important; max-height: 100vh !important;
        }
        .gs-body-fullscreen-active { overflow: hidden !important; }
        .gs-output-controls-container-fixed {
            position: fixed !important; top: 15px !important; right: 15px !important;
            z-index: 9999 !important; display: flex !important;
            align-items: center !important; gap: 0.25rem !important;
        }
        .gs-font-button-flash-red { animation: gs-flash-red 0.4s ease-out; }
        @keyframes gs-flash-red { 0% { background-color: #EF4444; } 100% { background-color: #374151; } }
        .gs-font-button-flash-blue { animation: gs-flash-blue 0.4s ease-out; }
        @keyframes gs-flash-blue { 0% { background-color: #3B82F6; } 100% { background-color: #374151; } }

        .iteration-log-table { border-collapse: collapse; margin: 10px auto; font-family: monospace; font-size:0.9em; width: 90%; }
        .iteration-log-table th, .iteration-log-table td { border: 1px solid #555; padding: 6px 10px; text-align: center; }
        .iteration-log-table th { background-color: #333; font-weight:normal; }
        .step-description { margin-top:15px; margin-bottom:5px; font-style: italic; text-align:center; font-size:0.9em;}

        /* D3 Visualization Styles for Gauss-Seidel */
        #gs-d3-charts-container {
            display: flex;
            flex-direction: column; /* Stack charts vertically */
            gap: 20px; /* Space between charts */
            align-items: center; /* Center charts if they don't take full width */
        }
        .gs-d3-chart {
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #gs-d3-svg-convergence-container .axis path,
        #gs-d3-svg-convergence-container .axis line,
        #gs-d3-svg-error-container .axis path,
        #gs-d3-svg-error-container .axis line {
            fill: none;
            stroke: #333;
            shape-rendering: crispEdges;
        }
        #gs-d3-svg-convergence-container .axis text,
        #gs-d3-svg-error-container .axis text {
            font-family: 'Inter', sans-serif;
            font-size: 0.75em;
            fill: #555;
        }
        #gs-d3-svg-convergence-container .line,
        #gs-d3-svg-error-container .line {
            fill: none;
            stroke-width: 2px;
        }
        #gs-d3-svg-convergence-container .dot,
        #gs-d3-svg-error-container .dot {
            stroke-width: 1px;
            stroke: white;
        }
        .gs-d3-tooltip {
            position: absolute;
            text-align: center;
            padding: 6px;
            font-size: 12px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .gs-d3-legend {
            font-family: 'Inter', sans-serif;
            font-size: 0.8em;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }
        .gs-d3-legend-item {
            display: flex;
            align-items: center;
        }
        .gs-d3-legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-custom-gray-bg text-gray-700 font-sans antialiased">
    <div id="app-gs">
        <header class="bg-custom-blue text-white shadow-md">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-xl font-semibold"><a href="../index.html" class="hover:text-gray-300">Métodos Numéricos</a></h1>
                <nav><a href="../index.html#method-cards-container" class="text-sm px-4 py-2 rounded-md hover:bg-gray-700 transition-colors duration-150">Volver a Métodos</a></nav>
            </div>
        </header>

        <div class="container mx-auto mt-8 mb-8 flex flex-col lg:flex-row lg:space-x-8 px-4">
            <left-sidebar-gs></left-sidebar-gs>
            <main class="w-full flex-1 min-w-0 bg-white shadow-xl rounded-lg p-6 md:p-8 order-2 mb-6 lg:mb-0">
                <article class="method-content">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b border-gray-200 pb-4">Método de Gauss-Seidel</h2>

                    <section id="teoria-gs" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Fundamento Teórico</h3>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            El método de Gauss-Seidel es un método iterativo utilizado para resolver sistemas de ecuaciones lineales. Es una mejora del método de Jacobi, ya que utiliza los valores actualizados de las incógnitas tan pronto como están disponibles en la misma iteración, en lugar de esperar a la siguiente iteración completa.
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            Dado un sistema de ecuaciones lineales \(Ax = b\), donde A es una matriz de coeficientes y b es un vector de términos independientes, el método descompone la matriz A en \(A = D + L + U\), donde D es la matriz diagonal de A, L es la parte triangular estrictamente inferior de A, y U es la parte triangular estrictamente superior de A.
                            La ecuación iterativa se puede escribir como \( (D+L)x^{(k+1)} = b - Ux^{(k)} \).
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            La fórmula iterativa para cada componente \(x_i\) en la iteración \((k+1)\) es:
                        </p>
                        <div class="text-center my-3 text-gray-600 tex2jax_process">
                        \[ x_i^{(k+1)} = \frac{1}{a_{ii}} \left( b_i - \sum_{j=1}^{i-1} a_{ij}x_j^{(k+1)} - \sum_{j=i+1}^{n} a_{ij}x_j^{(k)} \right) \]
                        </div>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            Donde \(k\) es el índice de la iteración. Nótese cómo para \(j < i\), se usan los valores \(x_j^{(k+1)}\) ya calculados en la iteración actual (\(k+1\)), y para \(j > i\), se usan los valores \(x_j^{(k)}\) de la iteración anterior (\(k\)).
                        </p>
                        <p class="text-gray-600 leading-relaxed">
                            La convergencia del método de Gauss-Seidel está garantizada si la matriz A es estrictamente diagonal dominante por filas o si es simétrica y definida positiva. Sin embargo, puede converger incluso si estas condiciones no se cumplen, aunque no está garantizado. Si la matriz es diagonalmente dominante, Gauss-Seidel generalmente converge más rápido que Jacobi.
                        </p>
                    </section>

                    <section id="algoritmo-gs" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Pasos del Algoritmo</h3>
                        <ol class="list-decimal list-inside space-y-3 pl-4 text-gray-600 leading-relaxed">
                            <li>
                                <strong>Reordenar (Opcional pero recomendado):</strong> Si es posible, reordenar las ecuaciones para que la matriz A sea diagonalmente dominante. Esto mejora las posibilidades de convergencia y a menudo su velocidad.
                            </li>
                            <li>
                                <strong>Aproximación Inicial:</strong> Elegir un vector de aproximación inicial \(x^{(0)}\). Comúnmente se usa un vector de ceros, \(x^{(0)} = [0, 0, \dots, 0]^T\).
                            </li>
                            <li>
                                <strong>Definir Criterios de Parada:</strong> Establecer una tolerancia \( \epsilon \) (error máximo admisible) y un número máximo de iteraciones \(N_{max}\).
                            </li>
                            <li>
                                <strong>Iterar:</strong> Para \(k = 0, 1, 2, \dots, N_{max}-1\):
                                <ol type="a" class="list-[lower-alpha] list-inside space-y-2 pl-6 mt-2">
                                    <li>
                                        Para cada incógnita \(i = 1, 2, \dots, n\) (donde \(n\) es el número de ecuaciones):
                                        <ol type="i" class="list-roman list-inside space-y-1 pl-4 mt-1">
                                            <li>
                                                Calcular la suma de los términos que usan valores ya actualizados en la iteración actual:
                                                <br>\( \sigma_1 = \sum_{j=1}^{i-1} a_{ij}x_j^{(k+1)} \)
                                            </li>
                                            <li>
                                                Calcular la suma de los términos que usan valores de la iteración anterior:
                                                <br>\( \sigma_2 = \sum_{j=i+1}^{n} a_{ij}x_j^{(k)} \)
                                            </li>
                                            <li>
                                                Actualizar \(x_i^{(k+1)}\):
                                                <br>Si \(a_{ii} \neq 0\), entonces \( x_i^{(k+1)} = \frac{1}{a_{ii}} (b_i - \sigma_1 - \sigma_2) \).
                                                <br>Si \(a_{ii} = 0\), el método no puede continuar directamente con esta ecuación en esta posición.
                                            </li>
                                        </ol>
                                    </li>
                                    <li>
                                        <strong>Verificar Convergencia:</strong> Calcular el error entre el vector solución actual \(x^{(k+1)}\) y el anterior \(x^{(k)}\). Una medida común es la norma infinito:
                                        <br>\( \text{Error} = \max_{1 \le i \le n} |x_i^{(k+1)} - x_i^{(k)}| \)
                                        <br>Otra opción es el error relativo: \( \text{ErrorRel} = \frac{\max |x_i^{(k+1)} - x_i^{(k)}|}{\max |x_i^{(k+1)}|} \) (si \( \max |x_i^{(k+1)}| \neq 0 \)).
                                    </li>
                                    <li>
                                        Si \(\text{Error} < \epsilon\), el proceso ha convergido. La solución aproximada es \(x^{(k+1)}\). Detener.
                                    </li>
                                </ol>
                            </li>
                            <li>
                                <strong>Resultado:</strong> Si se alcanza \(N_{max}\) sin que el error sea menor que \(\epsilon\), el método no convergió en el número de iteraciones permitido. Se puede reportar la última aproximación \(x^{(N_{max})}\) y una advertencia.
                            </li>
                        </ol>
                    </section>

                    <section id="ejemplo-gs" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Ejemplo Paso a Paso</h3>
                        <p class="text-gray-600 leading-relaxed mb-3"><strong>Problema:</strong> Resolver el sistema con Gauss-Seidel, \(x^{(0)} = [0, 0, 0]^T\), tolerancia \(\epsilon = 0.001\).</p>
                        <div class="text-center my-3 text-gray-600 tex2jax_process">
                            \(10x_1 - x_2 + 2x_3 = 6\)<br>
                            \(-x_1 + 11x_2 - x_3 = 25\)<br>
                            \(2x_1 - x_2 + 10x_3 = -11\)
                        </div>
                        <p class="text-gray-600 leading-relaxed mb-2"><strong>Ecuaciones de iteración:</strong></p>
                        <div class="text-center my-3 text-gray-600 tex2jax_process">
                            \(x_1^{(k+1)} = \frac{1}{10} (6 + x_2^{(k)} - 2x_3^{(k)})\)<br>
                            \(x_2^{(k+1)} = \frac{1}{11} (25 + x_1^{(k+1)} + x_3^{(k)})\)<br>
                            \(x_3^{(k+1)} = \frac{1}{10} (-11 - 2x_1^{(k+1)} + x_2^{(k+1)}) \)
                        </div>

                        <p class="font-medium text-gray-700 mb-1"><strong>Iteración 1 (k=0):</strong> Usando \(x^{(0)} = [0, 0, 0]^T\)</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 text-gray-600 break-words overflow-x-auto">
                            <li>\(x_1^{(1)} = \frac{1}{10} (6 + x_2^{(0)} - 2x_3^{(0)}) = \frac{1}{10} (6 + 0 - 2 \cdot 0) = 0.6\)</li>
                            <li>\(x_2^{(1)} = \frac{1}{11} (25 + x_1^{(1)} + x_3^{(0)}) = \frac{1}{11} (25 + 0.6 + 0) = \frac{25.6}{11} \approx 2.32727\)</li>
                            <li>\(x_3^{(1)} = \frac{1}{10} (-11 - 2x_1^{(1)} + x_2^{(1)}) = \frac{1}{10} (-11 - 2 \cdot 0.6 + 2.32727) = \frac{-11 - 1.2 + 2.32727}{10} = \frac{-9.87273}{10} \approx -0.98727\)</li>
                        </ul>
                        <p class="text-gray-600 leading-relaxed mt-1 break-words overflow-x-auto">\(x^{(1)} \approx [0.60000, 2.32727, -0.98727]^T\). Error \(\approx \max(|0.6|, |2.32727|, |-0.98727|) = 2.32727\).</p>

                        <p class="font-medium text-gray-700 mb-1 mt-3"><strong>Iteración 2 (k=1):</strong> Usando \(x^{(1)}\)</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 text-gray-600 break-words overflow-x-auto">
                            <li>\(x_1^{(2)} = \frac{1}{10} (6 + x_2^{(1)} - 2x_3^{(1)}) = \frac{1}{10} (6 + 2.32727 - 2(-0.98727)) = \frac{6 + 2.32727 + 1.97454}{10} = \frac{10.30181}{10} \approx 1.03018\)</li>
                            <li>\(x_2^{(2)} = \frac{1}{11} (25 + x_1^{(2)} + x_3^{(1)}) = \frac{1}{11} (25 + 1.03018 + (-0.98727)) = \frac{25.04291}{11} \approx 2.27663\)</li>
                            <li>\(x_3^{(2)} = \frac{1}{10} (-11 - 2x_1^{(2)} + x_2^{(2)}) = \frac{1}{10} (-11 - 2(1.03018) + 2.27663) = \frac{-11 - 2.06036 + 2.27663}{10} = \frac{-10.78373}{10} \approx -1.07837\)</li>
                        </ul>
                        <p class="text-gray-600 leading-relaxed mt-1 break-words overflow-x-auto">\(x^{(2)} \approx [1.03018, 2.27663, -1.07837]^T\). Error \(\approx \max(|1.03018 - 0.6|, |2.27663 - 2.32727|, |-1.07837 - (-0.98727)|) = \max(0.43018, 0.05064, 0.09110) \approx 0.43018\).</p>
                        <p class="text-gray-600 leading-relaxed mt-2">El proceso continúa hasta que el error sea menor que \(\epsilon = 0.001\). La solución exacta es \(x_1=1, x_2=2, x_3=-1\).</p>
                    </section>

                    <section id="codigo-gs" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Código de Implementación (Python)</h3>
                        <p class="text-gray-600 leading-relaxed mb-3">
                            El siguiente código implementa el método de Gauss-Seidel. Puedes modificar la matriz `A_matrix`, el vector `b_vector`, la estimación inicial `x_initial`, la tolerancia `tol` y el número máximo de iteraciones `max_iter` en el código para resolver diferentes sistemas.
                        </p>
                        <div class="code-editor-container bg-gray-50 p-4 rounded-lg shadow-inner">
                            <textarea id="gs-code-input" class="code-input w-full h-[600px] p-3 border border-gray-300 rounded-md font-mono text-sm" style="resize: none;">
import numpy as np

def format_iteration_html_gs(iter_num, x_vector, error, num_vars, precision=6):
    x_cols = "".join([f"<th>x<sub>{i+1}</sub></th>" for i in range(num_vars)])
    x_vals = "".join([f"<td>{val:.{precision}f}</td>" for val in x_vector])
    error_val_str = f"{error:.{precision}e}" if error is not None else "N/A"

    html = f"""
    <table class="iteration-log-table">
        <thead><tr><th>Iteración</th>{x_cols}<th>Error</th></tr></thead>
        <tbody><tr><td>{iter_num}</td>{x_vals}<td>{error_val_str}</td></tr></tbody>
    </table>
    """
    return html

def gauss_seidel_solve_pyodide(A_matrix_str, b_vector_str, x_initial_str="None", tol_str="1e-7", max_iter_str="100"):
    html_log_parts = []
    visualization_steps = [] # For D3.js

    try:
        A_list = eval(A_matrix_str)
        b_list = eval(b_vector_str)
        A = np.array(A_list, dtype=float)
        b_vec = np.array(b_list, dtype=float)
        n = len(b_vec)

        if x_initial_str.lower() == "none" or not x_initial_str:
            x = np.zeros(n, dtype=float)
        else:
            x_initial_list = eval(x_initial_str)
            x = np.array(x_initial_list, dtype=float)
            if len(x) != n:
                 raise ValueError(f"La longitud del vector inicial x ({len(x)}) no coincide con el número de variables ({n}).")


        tol = float(tol_str)
        max_iter = int(max_iter_str)
    except Exception as e:
        error_msg = f'<p style="color: red; text-align:center;">Error parseando entradas: {e}. Asegúrate que las matrices y vectores estén en formato Python, ej: A=[[1,2],[3,4]], b=[5,6], x_initial=[0,0].</p>'
        return None, error_msg, []

    if A.shape[0] != n or A.shape[1] != n:
        return None, '<p style="color: red; text-align:center;">Error: La matriz A debe ser cuadrada y compatible con b.</p>', []
    
    # Check for diagonal dominance (sufficient, not necessary condition)
    diag_A = np.diag(np.abs(A))
    sum_abs_off_diag = np.sum(np.abs(A), axis=1) - diag_A
    if not np.all(diag_A > sum_abs_off_diag):
        html_log_parts.append('<p class="step-description" style="color: orange;">Advertencia: La matriz A no es estrictamente diagonal dominante. La convergencia no está garantizada.</p>')

    html_log_parts.append('<p class="step-description">Iteración 0 (Valores Iniciales):</p>')
    html_log_parts.append(format_iteration_html_gs(0, x, None, n))
    visualization_steps.append({
        "iteration": 0,
        "x_vector": x.copy().tolist(),
        "error": None,
        "description": f"Valores iniciales: x = {x.round(5).tolist()}"
    })

    for k_iter in range(max_iter):
        x_old = x.copy()
        iter_description_parts = [f"Iteración {k_iter+1}:"]

        for i_eq in range(n):
            # Store value before update for this component for D3 or detailed log
            # val_before_update_xi = x[i_eq] 
            
            sigma1 = np.dot(A[i_eq, :i_eq], x[:i_eq])       # Sum with updated x from current iter
            sigma2 = np.dot(A[i_eq, i_eq+1:], x_old[i_eq+1:]) # Sum with x from previous iter
            
            if abs(A[i_eq, i_eq]) < 1e-12: # Avoid division by nearly zero
                desc_zero_diag = f"Error: Elemento diagonal A[{i_eq},{i_eq}] es cercano a cero en iteración {k_iter+1}. El método puede fallar o ser inestable."
                html_log_parts.append(f'<p style="color: red; text-align:center;">{desc_zero_diag}</p>')
                visualization_steps.append({
                    "iteration": k_iter + 1, "x_vector": x.tolist(), "error": np.nan, # Use NaN for error if stopped
                    "description": desc_zero_diag, "type": "error_stop"
                })
                # Potentially return here or let it continue if other components can be found
                # For simplicity, we'll let it try to continue, but a robust implementation might stop.
                # A[i_eq, i_eq] could be set to a small epsilon to avoid literal div by zero if one wants to try to proceed.
                # For now, we'll let it produce NaN/Inf if A[i,i] is truly zero.
            
            x[i_eq] = (b_vec[i_eq] - sigma1 - sigma2) / A[i_eq, i_eq]
            iter_description_parts.append(f"  x<sub>{i_eq+1}</sub> actualizado a {x[i_eq]:.6f} (era {x_old[i_eq]:.6f})")

        current_error = np.linalg.norm(x - x_old, np.inf) # Infinity norm for error
        
        html_log_parts.append(f'<p class="step-description">Iteración {k_iter+1}:</p>')
        html_log_parts.append(format_iteration_html_gs(k_iter + 1, x, current_error, n))
        
        visualization_steps.append({
            "iteration": k_iter + 1,
            "x_vector": x.copy().tolist(),
            "x_old_vector": x_old.copy().tolist(), 
            "error": current_error,
            "description": "\n".join(iter_description_parts) + f"\nError: {current_error:.6e}",
            "type": "iteration_step"
        })

        if current_error < tol:
            success_msg = f"Convergencia alcanzada después de {k_iter+1} iteraciones."
            html_log_parts.append(f'<p class="step-description" style="color: green; font-weight:bold;">{success_msg}</p>')
            visualization_steps.append({
                "iteration": k_iter + 1, "x_vector": x.tolist(), "error": current_error,
                "description": success_msg, "type": "converged"
            })
            return x, "".join(html_log_parts), visualization_steps
        
        if np.isnan(current_error) or np.isinf(current_error):
            fail_msg = f"Divergencia detectada en la iteración {k_iter+1} (error es NaN o Inf)."
            html_log_parts.append(f'<p class="step-description" style="color: red; font-weight:bold;">{fail_msg}</p>')
            visualization_steps.append({
                "iteration": k_iter + 1, "x_vector": x.tolist(), "error": np.nan,
                "description": fail_msg, "type": "diverged"
            })
            return None, "".join(html_log_parts), visualization_steps


    # Max iterations reached
    max_iter_msg = f"Se alcanzó el número máximo de iteraciones ({max_iter}). Error actual: {current_error:.6e}"
    html_log_parts.append(f'<p class="step-description" style="color: orange;">{max_iter_msg}</p>')
    visualization_steps.append({
        "iteration": max_iter, "x_vector": x.tolist(), "error": current_error,
        "description": max_iter_msg, "type": "max_iterations_reached"
    })
    return x, "".join(html_log_parts), visualization_steps

# --- Parámetros Ejemplo ---
default_A_matrix_str_gs = "[[10, -1, 2], [-1, 11, -1], [2, -1, 10]]"
default_b_vector_str_gs = "[6, 25, -11]"
default_x_initial_str_gs = "[0, 0, 0]" # o "None"
default_tol_str_gs = "1e-5"
default_max_iter_str_gs = "30"

# --- Bloque principal para ejecución en Pyodide ---
if __name__ == "__main__":
    py_html_buffer = []

    A_str = globals().get("A_matrix_param_gs", default_A_matrix_str_gs)
    b_str = globals().get("b_vector_param_gs", default_b_vector_str_gs)
    x_init_str = globals().get("x_initial_param_gs", default_x_initial_str_gs)
    tol_val_str = globals().get("tol_param_gs", default_tol_str_gs)
    max_iter_val_str = globals().get("max_iter_param_gs", default_max_iter_str_gs)

    py_html_buffer.append('<div style="text-align: center; font-weight: bold; margin-bottom:15px; font-size:1.1em; padding-top:10px;">MÉTODO DE GAUSS-SEIDEL (Salida de Texto)</div>')
    try:
        A_disp = np.array(eval(A_str))
        b_disp = np.array(eval(b_str))
        x_init_disp_str = x_init_str
        if x_init_str.lower() == "none": x_init_disp_str = "Vector de ceros (por defecto)"
        else: x_init_disp_str = str(np.array(eval(x_init_str)))


        py_html_buffer.append(f'<div style="text-align: center; margin-bottom:5px; font-family:monospace;">Matriz A:<br>{str(A_disp).replace(" ", "&nbsp;")}</div>')
        py_html_buffer.append(f'<div style="text-align: center; margin-bottom:5px; font-family:monospace;">Vector b:<br>{str(b_disp).replace(" ", "&nbsp;")}</div>')
        py_html_buffer.append(f'<div style="text-align: center; margin-bottom:5px; font-family:monospace;">x inicial:<br>{x_init_disp_str.replace(" ", "&nbsp;")}</div>')
        py_html_buffer.append(f'<div style="text-align: center; margin-bottom:5px;">Tolerancia: {tol_val_str}</div>')
        py_html_buffer.append(f'<div style="text-align: center; margin-bottom:15px;">Max Iteraciones: {max_iter_val_str}</div>')

    except Exception as e:
        py_html_buffer.append(f'<p style="color:red; text-align:center;">Error al mostrar parámetros de entrada: {e}</p>')

    solution_gs, log_html_gs, d3_steps_gs = gauss_seidel_solve_pyodide(A_str, b_str, x_init_str, tol_val_str, max_iter_val_str)
    py_html_buffer.append(log_html_gs)

    if solution_gs is not None:
        py_html_buffer.append('<div style="text-align: center; font-weight: bold; margin-top: 20px; margin-bottom: 10px;">RESULTADOS FINALES (Texto)</div>')
        sol_str_gs = ", ".join([f"{x_val:.6f}" for x_val in solution_gs])
        py_html_buffer.append(f'<div style="text-align:center; padding:5px;">Solución aproximada (x): [{sol_str_gs}]</div>')
        try:
            A_val = np.array(eval(A_str))
            b_val = np.array(eval(b_str))
            Ax = A_val @ solution_gs
            error_vec = Ax - b_val.flatten()
            final_residual_norm = np.linalg.norm(error_vec)
            py_html_buffer.append(f'<div style="text-align:center; font-size:0.85em; padding:5px;">Verificación A*x = {str(Ax.round(5))} (Original b = {str(b_val.round(5))})</div>')
            py_html_buffer.append(f'<div style="text-align:center; font-size:0.85em; padding:5px;">Norma del residual ||Ax - b||: {final_residual_norm:.2e}</div>')
        except Exception as e_verify:
            py_html_buffer.append(f'<p style="color:orange; text-align:center;">No se pudo verificar la solución: {e_verify}</p>')
    elif "Divergencia detectada" not in log_html_gs and "Error: Elemento diagonal" not in log_html_gs : # if None and not divergence
         py_html_buffer.append('<div style="text-align: center; color: orange; margin-top:10px; padding:5px;">El método no convergió o no se encontró una solución con los parámetros dados.</div>')


    chart_data_package_gs = {
        "visualization_steps": d3_steps_gs,
        "solution_vector": solution_gs.tolist() if solution_gs is not None else None,
        "num_variables": len(eval(b_str)) if b_str else 0
    }

    if "pyodide_js" in globals():
        pyodide_globals = globals()['pyodide_js'].globals
        pyodide_globals.set("pyodide_gs_html_output", "".join(py_html_buffer))
        
        # Clear and set chart data package
        chart_data_proxy_out = pyodide_globals.get("pyodide_gs_chart_data_package")
        if chart_data_proxy_out is not None and hasattr(chart_data_proxy_out, 'clear'):
            chart_data_proxy_out.clear()
            for key, value in chart_data_package_gs.items():
                chart_data_proxy_out.set(key, value)
        else:
            from pyodide.ffi import to_js
            pyodide_globals.set("pyodide_gs_chart_data_package", to_js(chart_data_package_gs, dict_converter=js.Object.fromEntries))
    else: # Fallback
        global pyodide_gs_html_output, pyodide_gs_chart_data_package
        pyodide_gs_html_output = "".join(py_html_buffer)
        pyodide_gs_chart_data_package = chart_data_package_gs
                            </textarea>
                            <button id="run-gs-code-button" class="run-button mt-4 px-5 py-2.5 bg-custom-red text-white rounded-md hover:bg-red-700">Ejecutar Código</button>
                            <div class="relative mt-5">
                                <h4 class="mb-2 text-lg font-semibold text-gray-700">Salida de Texto:</h4>
                                <div id="gs-output-controls-container" class="absolute top-0 right-0 z-10 flex items-center space-x-1 transition-all duration-500 ease-out">
                                    <button id="gs-decrease-font-button" title="Disminuir fuente" class="p-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 text-xs font-semibold flex items-center justify-center" style="min-width: 30px;">aa</button>
                                    <button id="gs-increase-font-button" title="Aumentar fuente" class="p-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 text-xs font-semibold flex items-center justify-center" style="min-width: 30px;">AA</button>
                                    <button id="gs-fullscreen-output-button" title="Ver en pantalla completa" class="p-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 text-xs">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9m5.25 11.25v-4.5m0 4.5h-4.5m4.5 0L15 15" /></svg>
                                    </button>
                                </div>
                                <pre id="gs-code-output" class="code-output bg-gray-900 text-white p-4 pt-8 rounded-md min-h-[100px] whitespace-pre-wrap text-xs leading-relaxed max-h-96 overflow-y-auto font-mono transition-all duration-500 ease-out">Presiona "Ejecutar Código" para ver la salida de texto detallada.</pre>
                            </div>
                        </div>
                    </section>

                    <section id="graficas-gs" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Visualización Interactiva de Gauss-Seidel</h3>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            Observa la convergencia de las componentes de la solución \(x\) y la disminución del error a lo largo de las iteraciones.
                            Usa los controles para navegar entre los pasos.
                        </p>
                        <div id="gauss-seidel-d3-visualization" class="bg-gray-100 p-4 rounded-lg shadow-inner">
                            <div id="gs-d3-controls" class="mb-4 flex flex-wrap items-center justify-center gap-2">
                                <button id="gs-d3-prev" class="p-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Anterior"></button>
                                <button id="gs-d3-next" class="p-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Siguiente"></button>
                                <button id="gs-d3-play" class="p-2.5 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Play"></button>
                                <input type="range" id="gs-d3-slider" min="0" value="0" class="mx-2 flex-grow max-w-xs align-middle accent-custom-red disabled:opacity-50 disabled:cursor-not-allowed">
                                <div class="flex items-center text-sm">
                                    <label for="gs-d3-speed" class="mr-1">Velocidad:</label>
                                    <input type="range" id="gs-d3-speed" min="100" max="2000" value="500" step="100" class="w-24 align-middle accent-custom-red">
                                    <span id="gs-d3-speed-value" class="ml-1 w-10 text-right">500ms</span>
                                </div>
                            </div>
                            <div id="gs-d3-operation-description" class="mb-3 text-sm text-center font-mono h-auto min-h-[2em] p-2 bg-blue-50 border border-blue-200 text-blue-700 rounded-md leading-tight">
                                Ejecute el código para generar la visualización.
                            </div>
                            <div id="gs-d3-charts-container" class="flex flex-col items-center gap-y-6">
                                <div class="w-full max-w-2xl">
                                    <h4 class="text-center text-md font-semibold text-gray-700 mb-1">Convergencia de Componentes \(x_i\)</h4>
                                    <div id="gs-d3-legend-convergence" class="gs-d3-legend mb-1"></div>
                                    <svg id="gs-d3-svg-convergence-container" class="gs-d3-chart w-full h-64"></svg>
                                </div>
                                <div class="w-full max-w-2xl mt-4">
                                     <h4 class="text-center text-md font-semibold text-gray-700 mb-1">Convergencia del Error</h4>
                                    <svg id="gs-d3-svg-error-container" class="gs-d3-chart w-full h-56"></svg>
                                </div>
                            </div>
                            <div class="gs-d3-tooltip"></div>
                        </div>
                    </section>

                    <section id="videos-gs" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Videos Explicativos</h3>
                        <div class="video-embed w-full h-96">
                            <iframe class="w-full h-full rounded-lg shadow-lg" src="https://www.youtube.com/embed/fpUXDxHsyBI" title="YouTube video player - Método de Gauss-Seidel (Explicación Alternativa)" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                        </div>
                    </section>

                    <section id="conclusion-gs" class="mb-10 scroll-mt-24">
                         <h3 class="text-2xl font-semibold mb-4 text-gray-700">Conclusión y Aplicaciones</h3>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            El método de Gauss-Seidel es generalmente más rápido en converger que el método de Jacobi porque utiliza la información más reciente disponible para cada componente de la solución dentro de la misma iteración. Su convergencia depende crucialmente de las propiedades de la matriz de coeficientes A (por ejemplo, ser estrictamente diagonal dominante o simétrica y definida positiva).
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            Si no se cumplen las condiciones de convergencia, o si la matriz no está bien condicionada para el método, Gauss-Seidel puede converger lentamente o incluso divergir. Es particularmente eficiente para sistemas grandes y dispersos (con muchos ceros en la matriz A), donde los métodos directos como la eliminación de Gauss-Jordan pueden ser computacionalmente muy costosos o sufrir de acumulación de errores de redondeo.
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-2 font-medium"><strong>Aplicaciones:</strong></p>
                        <ul class="list-disc list-inside space-y-2 pl-4 text-gray-600 mb-4">
                            <li>Resolución de grandes sistemas de ecuaciones lineales que surgen en la discretización de ecuaciones diferenciales parciales (EDPs) mediante diferencias finitas o elementos finitos, comunes en problemas de ingeniería y física (ej. distribución de temperaturas, flujo de fluidos, campos electromagnéticos).</li>
                            <li>En problemas de optimización y modelado de redes.</li>
                            <li>Cuando la matriz del sistema es grande, dispersa y cumple con las condiciones de convergencia.</li>
                            <li>Como precondicionador para otros métodos iterativos más avanzados.</li>
                        </ul>
                    </section>

                    <section id="referencias-gs" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Referencias</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-600 leading-relaxed pl-4">
                            <li>Chapra, S. C., & Canale, R. P. (2015). <em>Numerical Methods for Engineers</em> (7th ed.). McGraw-Hill Education. (Capítulo 11).</li>
                            <li>Burden, R. L., & Faires, J. D. (2011). <em>Numerical Analysis</em> (9th ed.). Brooks/Cole.</li>
                        </ul>
                    </section>

                    <section id="cuestionario-gs" class="scroll-mt-24 mb-10">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Cuestionario: Método de Gauss-Seidel</h3>
                        <form id="quiz-gauss-seidel" class="space-y-6 bg-gray-50 p-6 rounded-lg shadow-inner">
                            <!-- Pregunta 1 -->
                            <div class="quiz-question space-y-2">
                                <p class="text-sm font-medium text-gray-700">1. ¿Cuál es la principal diferencia en cómo el método de Gauss-Seidel utiliza los valores de las incógnitas en comparación con el método de Jacobi?</p>
                                <fieldset class="mt-2">
                                    <legend class="sr-only">Opciones para la pregunta 1</legend>
                                    <div class="space-y-2">
                                        <label for="q1-opt1-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q1-opt1-gs" name="question-1-gs" type="radio" value="Gauss-Seidel usa solo los valores de la iteración anterior para todas las incógnitas." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Gauss-Seidel usa solo los valores de la iteración anterior para todas las incógnitas.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q1-opt2-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q1-opt2-gs" name="question-1-gs" type="radio" value="Gauss-Seidel utiliza los valores más recientes de las incógnitas, incluyendo los ya calculados en la misma iteración actual." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Gauss-Seidel utiliza los valores más recientes de las incógnitas, incluyendo los ya calculados en la misma iteración actual.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q1-opt3-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q1-opt3-gs" name="question-1-gs" type="radio" value="Gauss-Seidel requiere el doble de iteraciones que Jacobi para converger." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Gauss-Seidel requiere el doble de iteraciones que Jacobi para converger.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                    </div>
                                </fieldset>
                                <div id="question-1-gs-specific-feedback" class="specific-question-feedback mt-2 p-2.5 text-xs bg-red-50 text-red-600 border border-red-200 rounded-md" style="display: none;"></div>
                            </div>

                            <!-- Pregunta 2 -->
                            <div class="quiz-question space-y-2">
                                <p class="text-sm font-medium text-gray-700">2. ¿Cuál de las siguientes condiciones es suficiente (pero no necesaria) para garantizar la convergencia del método de Gauss-Seidel?</p>
                                <fieldset class="mt-2">
                                    <legend class="sr-only">Opciones para la pregunta 2</legend>
                                    <div class="space-y-2">
                                        <label for="q2-opt1-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q2-opt1-gs" name="question-2-gs" type="radio" value="La matriz A es singular." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">La matriz A es singular.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q2-opt2-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q2-opt2-gs" name="question-2-gs" type="radio" value="La matriz A es estrictamente diagonal dominante." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">La matriz A es estrictamente diagonal dominante.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q2-opt3-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q2-opt3-gs" name="question-2-gs" type="radio" value="Todos los elementos de la diagonal principal de A son 1." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Todos los elementos de la diagonal principal de A son 1.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                    </div>
                                </fieldset>
                                <div id="question-2-gs-specific-feedback" class="specific-question-feedback mt-2 p-2.5 text-xs bg-red-50 text-red-600 border border-red-200 rounded-md" style="display: none;"></div>
                            </div>

                            <!-- Pregunta 3 -->
                            <div class="quiz-question space-y-2">
                                <p class="text-sm font-medium text-gray-700">3. Si el método de Gauss-Seidel no converge después del número máximo de iteraciones especificado, ¿qué se puede concluir?</p>
                                <fieldset class="mt-2">
                                    <legend class="sr-only">Opciones para la pregunta 3</legend>
                                    <div class="space-y-2">
                                        <label for="q3-opt1-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q3-opt1-gs" name="question-3-gs" type="radio" value="El sistema no tiene solución." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">El sistema no tiene solución.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q3-opt2-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q3-opt2-gs" name="question-3-gs" type="radio" value="El método no convergió dentro del límite de iteraciones (puede converger más lento, divergir, o la tolerancia es muy estricta)." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">El método no convergió dentro del límite de iteraciones (puede converger más lento, divergir, o la tolerancia es muy estricta).</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q3-opt3-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q3-opt3-gs" name="question-3-gs" type="radio" value="La estimación inicial x(0) era incorrecta." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">La estimación inicial \(x^{(0)}\) era incorrecta.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                    </div>
                                </fieldset>
                                <div id="question-3-gs-specific-feedback" class="specific-question-feedback mt-2 p-2.5 text-xs bg-red-50 text-red-600 border border-red-200 rounded-md" style="display: none;"></div>
                            </div>

                             <!-- Pregunta 4 -->
                             <div class="quiz-question space-y-2">
                                <p class="text-sm font-medium text-gray-700">4. Para un sistema \(Ax=b\) donde \(A = \begin{pmatrix} 2 & -1 \\ -1 & 3 \end{pmatrix}\), \(b = \begin{pmatrix} 1 \\ 5 \end{pmatrix}\) y \(x^{(0)} = \begin{pmatrix} 0 \\ 0 \end{pmatrix}\). ¿Cuál es el valor de \(x_1^{(1)}\) en la primera iteración de Gauss-Seidel?</p>
                                <fieldset class="mt-2">
                                    <legend class="sr-only">Opciones para la pregunta 4</legend>
                                    <div class="space-y-2">
                                        <label for="q4-opt1-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q4-opt1-gs" name="question-4-gs" type="radio" value="0" class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">0</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q4-opt2-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q4-opt2-gs" name="question-4-gs" type="radio" value="0.5" class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">0.5</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q4-opt3-gs" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q4-opt3-gs" name="question-4-gs" type="radio" value="1" class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">1</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                    </div>
                                </fieldset>
                                <div id="question-4-gs-specific-feedback" class="specific-question-feedback mt-2 p-2.5 text-xs bg-red-50 text-red-600 border border-red-200 rounded-md" style="display: none;"></div>
                            </div>

                            <button type="submit" class="mt-6 w-full px-6 py-3 bg-custom-red text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-150">
                                Enviar Respuestas
                            </button>
                        </form>
                        <div id="quiz-feedback-gauss-seidel" class="quiz-feedback-message mt-4 p-3 rounded-md text-sm" style="display: none;"></div>
                    </section>
                </article>
            </main>

            <aside class="w-full lg:w-1/4 bg-sidebar-bg shadow-xl rounded-lg p-6 self-start sticky top-8 order-3 space-y-6">
                <div class="pb-6 border-b border-gray-200">
                    <h3 class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">Perfil</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                           <svg class="w-12 h-12 text-gray-400 bg-gray-100 rounded-full p-1 ring-1 ring-gray-200" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800 text-md">Estudiante Iterativo</p>
                            <p class="text-sm text-gray-500">Analista de Convergencia</p>
                        </div>
                    </div>
                </div>

                <div class="pb-6 border-b border-gray-200 space-y-3">
                    <h3 class="text-base font-semibold text-gray-500 uppercase tracking-wide">Progreso en Gauss-Seidel</h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center">
                            <span id="task-read-theory-status-gs" class="task-status-icon mr-2 text-gray-400"></span>
                            <span class="text-gray-600">Leer la teoría completa</span>
                        </li>
                        <li class="flex items-center">
                            <span id="task-run-code-status-gs" class="task-status-icon mr-2 text-gray-400"></span>
                            <span class="text-gray-600">Ejecutar el código Python</span>
                        </li>
                        <li class="flex items-center">
                            <span id="task-quiz-attempted-status-gs" class="task-status-icon mr-2 text-gray-400"></span>
                            <span class="text-gray-600">Intentar el cuestionario</span>
                        </li>
                        <li class="flex items-center">
                            <span id="task-quiz-passed-status-gs" class="task-status-icon mr-2 text-gray-400"></span>
                            <span class="text-gray-600">Aprobar el cuestionario</span>
                        </li>
                    </ul>
                    <div class="flex items-center justify-between mb-1 mt-3">
                       <span class="text-xs font-medium text-custom-red">Progreso General</span>
                       <span id="right-sidebar-progress-text-gs" class="text-xs font-medium text-custom-red right-sidebar-progress-text">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="right-sidebar-progress-bar-gs" class="bg-custom-red h-3 rounded-full right-sidebar-progress-bar transition-width duration-500 ease-in-out" style="width: 0%"></div>
                    </div>
                    <button id="completion-gauss-seidel-sidebar" class="mt-4 w-full completion-button px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Marcar Todo Completado</button>
                </div>
                <div class="pb-6 border-b border-gray-200">
                    <h3 class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-3">Recursos y Notas</h3>
                    <p class="text-sm text-gray-600"><a href="https://archive.org/details/numerical-methods-for-engineers-7th-edit" target="_blank" rel="noopener noreferrer" class="hover:text-custom-red hover:underline">Métodos Numéricos para Ingenieros 7ma Edición de Chapra</a></p>
                    <img src="https://images.cdn3.buscalibre.com/fit-in/360x360/97/ff/97ffa61a8adb147e569e12c4f1f797b3.jpg" alt="Portada Chapra" class="mt-2 w-full rounded-md shadow-sm">
                </div>
                <div>
                    <h3 class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-3">Siguiente Paso</h3>
                    <a href="../methods/jacobi.html" class="group flex items-center text-sm font-medium text-custom-red hover:text-red-700"> <!-- Update Link -->
                       <span>Explorar Metodo de Jacobi</span>
                       <svg class="w-4 h-4 ml-1 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </a>
                </div>
            </aside>
        </div>

        <footer class="bg-custom-blue text-gray-300 text-center p-6 mt-12">
            <p>&copy; 2024 Plataforma Educativa de Métodos Numéricos. <a href="../index.html" class="hover:text-white underline">Volver al inicio</a></p>
        </footer>
    </div>

    <!-- GS SCRIPT (Logica JS General de la página, Pyodide, Quiz, D3) -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const PAGE_KEY_GS = 'gauss-seidel';
        const QUIZ_FORM_ID_GS = 'quiz-gauss-seidel';
        const QUIZ_FEEDBACK_ID_GS = 'quiz-feedback-gauss-seidel';
        const COMPLETION_BUTTON_ID_GS = 'completion-gauss-seidel-sidebar';
        const CODE_INPUT_ID_GS = 'gs-code-input';
        const CODE_OUTPUT_ID_GS = 'gs-code-output';
        const RUN_CODE_BUTTON_ID_GS = 'run-gs-code-button';
        const outputControlsContainer_GS = document.getElementById('gs-output-controls-container');
        const fullscreenButton_GS = document.getElementById('gs-fullscreen-output-button');
        const increaseFontButton_GS = document.getElementById('gs-increase-font-button');
        const decreaseFontButton_GS = document.getElementById('gs-decrease-font-button');
        let originalOutputFontSize_GS = '';
        const MIN_FONT_SIZE_PX_GS = 8;
        const MAX_FONT_SIZE_PX_GS = 28;
        const FONT_SIZE_STEP_PX_GS = 1;
        let gsCodeOutputInitialRect = null;

        const TASKS_GS = {
            READ_THEORY: 'read_theory_gs',
            RUN_CODE: 'run_code_gs',
            QUIZ_ATTEMPTED: 'quiz_attempted_gs',
            QUIZ_PASSED: 'quiz_passed_gs'
        };
        const ALL_TASK_KEYS_GS = Object.values(TASKS_GS);
        const TOTAL_TASKS_GS = ALL_TASK_KEYS_GS.length;

        const ICON_PENDING_GS = '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0-4.418-4.03-8-9-8S3 7.582 3 12c0 1.454.402 2.813 1.098 3.977L3 21l5.023-1.098A8.902 8.902 0 0012 21c4.97 0 9-3.582 9-9z"></path></svg>';
        const ICON_COMPLETED_GS = '<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
        const ICON_IN_PROGRESS_GS = '<svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V9.05a.75.75 0 011.307-.588l5.603 3.112z" clip-rule="evenodd"></path></svg>'; // Example
        const ICON_CORRECT_ANSWER_GS = '✔️';
        const ICON_INCORRECT_ANSWER_GS = '❌';
        const ICON_THUMB_UP_GS = '👍';
        const quizDataGaussSeidel = {
            "question-1-gs": {
                correctAnswer: "Gauss-Seidel utiliza los valores más recientes de las incógnitas, incluyendo los ya calculados en la misma iteración actual.",
                feedback: {
                    "Gauss-Seidel usa solo los valores de la iteración anterior para todas las incógnitas.": "Incorrecto. Esto describe al método de Jacobi.",
                    "Gauss-Seidel requiere el doble de iteraciones que Jacobi para converger.": "Incorrecto. Gauss-Seidel generalmente converge más rápido que Jacobi si lo hace."
                }
            },
            "question-2-gs": {
                correctAnswer: "La matriz A es estrictamente diagonal dominante.",
                feedback: {
                    "La matriz A es singular.": "Incorrecto. Si A es singular, el sistema no tiene solución única, y los métodos iterativos no convergerán a una solución única.",
                    "Todos los elementos de la diagonal principal de A son 1.": "Incorrecto. Esto no es una condición suficiente por sí sola."
                }
            },
            "question-3-gs": {
                correctAnswer: "El método no convergió dentro del límite de iteraciones (puede converger más lento, divergir, o la tolerancia es muy estricta).",
                feedback: {
                    "El sistema no tiene solución.": "Incorrecto. La no convergencia del método no implica necesariamente que no haya solución; podría ser que el método no es adecuado para este sistema o los parámetros son incorrectos.",
                    "La estimación inicial x(0) era incorrecta.": "Incorrecto. Aunque una mala estimación inicial puede afectar el número de iteraciones, si el método es convergente para el sistema, debería converger eventualmente."
                }
            },
            "question-4-gs": { // x1_new = (1 - (-1)*x2_old) / 2 = (1 + x2_old) / 2.  x2_old = 0. So, x1_new = (1+0)/2 = 0.5
                correctAnswer: "0.5",
                feedback: {
                    "0": "Incorrecto. Revisa la fórmula de Gauss-Seidel: \(x_1^{(k+1)} = (b_1 - a_{12}x_2^{(k)}) / a_{11}\).",
                    "1": "Incorrecto. Parece que podrías haber omitido dividir por \(a_{11}\)."
                }
            }
        };

        let pyodide_GS = null;
        const mainCompletionButton_GS = document.getElementById(COMPLETION_BUTTON_ID_GS);
        const quizForm_GS = document.getElementById(QUIZ_FORM_ID_GS);
        const generalQuizFeedbackDiv_GS = document.getElementById(QUIZ_FEEDBACK_ID_GS);
        const codeInput_GS = document.getElementById(CODE_INPUT_ID_GS);
        const codeOutput_GS = document.getElementById(CODE_OUTPUT_ID_GS);
        const runCodeButton_GS = document.getElementById(RUN_CODE_BUTTON_ID_GS);

        const taskStatusIcons_GS = {};
        taskStatusIcons_GS[TASKS_GS.READ_THEORY] = document.getElementById('task-read-theory-status-gs');
        taskStatusIcons_GS[TASKS_GS.RUN_CODE] = document.getElementById('task-run-code-status-gs');
        taskStatusIcons_GS[TASKS_GS.QUIZ_ATTEMPTED] = document.getElementById('task-quiz-attempted-status-gs');
        taskStatusIcons_GS[TASKS_GS.QUIZ_PASSED] = document.getElementById('task-quiz-passed-status-gs');
        const overallProgressText_GS = document.getElementById('right-sidebar-progress-text-gs');
        const overallProgressBar_GS = document.getElementById('right-sidebar-progress-bar-gs');


        function getPageProgressFromStorage_GS(pKey) {
            const defaults = ALL_TASK_KEYS_GS.reduce((obj, task) => ({ ...obj, [task]: false }), {});
            defaults.overall_progress = 0;
            defaults.user_quiz_answers = {};
            defaults.quiz_current_score = 0;
            defaults.quiz_feedback_active = false;
            try {
                const stored = localStorage.getItem(pKey);
                if (stored) return { ...defaults, ...JSON.parse(stored) };
            } catch (e) { console.error("Error al leer localStorage para GS:", e); }
            return defaults;
        }

        function savePageProgressToStorage_GS(pKey, progress) {
            try {
                localStorage.setItem(pKey, JSON.stringify(progress));
                window.dispatchEvent(new CustomEvent('gsPageProgressSaved', { detail: { pageKey: pKey, progress } }));
            } catch (e) { console.error("Error al guardar en localStorage para GS:", e); }
        }

        function updateTaskStatusInStorage_GS(taskName, isCompleted) {
            let currentProgress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
            if (currentProgress[taskName] !== isCompleted) {
                currentProgress[taskName] = isCompleted;
                if (taskName === TASKS_GS.QUIZ_ATTEMPTED && !isCompleted) {
                    currentProgress[TASKS_GS.QUIZ_PASSED] = false;
                    currentProgress.user_quiz_answers = {};
                    currentProgress.quiz_current_score = 0;
                    currentProgress.quiz_feedback_active = false;
                }
                if (taskName === TASKS_GS.QUIZ_PASSED && isCompleted) {
                     currentProgress[TASKS_GS.QUIZ_ATTEMPTED] = true;
                }
                savePageProgressToStorage_GS(PAGE_KEY_GS, currentProgress);
                calculateAndUpdateOverallProgress_GS();
            }
        }

        function renderTaskStatus_GS() {
            const progress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
            ALL_TASK_KEYS_GS.forEach(taskKey => {
                const iconElement = taskStatusIcons_GS[taskKey];
                if (iconElement) {
                    let newIconHTML = ICON_PENDING_GS;
                    if (progress[taskKey]) newIconHTML = ICON_COMPLETED_GS;
                    else if (taskKey === TASKS_GS.QUIZ_PASSED && progress[TASKS_GS.QUIZ_ATTEMPTED]) newIconHTML = ICON_IN_PROGRESS_GS;
                    iconElement.innerHTML = newIconHTML;
                }
            });
        }

        function calculateAndUpdateOverallProgress_GS() {
            let progress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
            let completedTasks = ALL_TASK_KEYS_GS.filter(taskKey => progress[taskKey]).length;
            const percentage = TOTAL_TASKS_GS > 0 ? (completedTasks / TOTAL_TASKS_GS) * 100 : 0;
            progress.overall_progress = percentage;
            savePageProgressToStorage_GS(PAGE_KEY_GS, progress);

            const isHundredPercent = percentage.toFixed(0) === '100';
            if (overallProgressBar_GS) {
                overallProgressBar_GS.style.width = `${percentage.toFixed(0)}%`;
                overallProgressBar_GS.classList.toggle('animate-rainbow-border', isHundredPercent);
            }
            if (overallProgressText_GS) overallProgressText_GS.textContent = `${percentage.toFixed(0)}%`;

            renderTaskStatus_GS();
            updateMainCompletionButtonState_GS();
        }

        function handleMarkAllMouseEnter_GS() {
            if (mainCompletionButton_GS && mainCompletionButton_GS.dataset.isUndo === "true") {
                mainCompletionButton_GS.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                mainCompletionButton_GS.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        function handleMarkAllMouseLeave_GS() {
            if (mainCompletionButton_GS && mainCompletionButton_GS.dataset.isUndo === "true") {
                mainCompletionButton_GS.classList.remove('bg-red-600', 'hover:bg-red-700');
                mainCompletionButton_GS.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            }
        }

        function updateMainCompletionButtonState_GS() {
            if (!mainCompletionButton_GS) return;
            const progress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
            let allTasksCompleted = ALL_TASK_KEYS_GS.every(task => progress[task]);

            mainCompletionButton_GS.removeEventListener('mouseenter', handleMarkAllMouseEnter_GS);
            mainCompletionButton_GS.removeEventListener('mouseleave', handleMarkAllMouseLeave_GS);
            mainCompletionButton_GS.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-yellow-500', 'hover:bg-yellow-600', 'bg-red-600', 'hover:bg-red-700');

            if (allTasksCompleted) {
                mainCompletionButton_GS.textContent = 'Deshacer Completado';
                mainCompletionButton_GS.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                mainCompletionButton_GS.dataset.isUndo = "true";
                mainCompletionButton_GS.addEventListener('mouseenter', handleMarkAllMouseEnter_GS);
                mainCompletionButton_GS.addEventListener('mouseleave', handleMarkAllMouseLeave_GS);
            } else {
                mainCompletionButton_GS.textContent = 'Marcar Todo Completado';
                mainCompletionButton_GS.classList.add('bg-green-600', 'hover:bg-green-700');
                mainCompletionButton_GS.dataset.isUndo = "false";
            }
        }

        function clearAllVisualFeedback_GS(clearGeneralMessage = false) {
            if (!quizForm_GS) return;
            quizForm_GS.querySelectorAll('.quiz-option-wrapper').forEach(wrapper => {
                wrapper.classList.remove('correct-answer-gs', 'incorrect-answer-gs', 'border-green-500', 'border-red-500', 'ring-1', 'ring-green-500', 'ring-red-500', 'bg-green-50', 'bg-red-50');
                wrapper.classList.add('border-gray-300', 'hover:border-gray-400', 'has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red');
                const iconPlaceholder = wrapper.querySelector('.feedback-icon-placeholder span');
                if (iconPlaceholder) iconPlaceholder.innerHTML = '';
            });
            quizForm_GS.querySelectorAll('.specific-question-feedback').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
            if (clearGeneralMessage && generalQuizFeedbackDiv_GS) {
                generalQuizFeedbackDiv_GS.textContent = '';
                generalQuizFeedbackDiv_GS.style.display = 'none';
                generalQuizFeedbackDiv_GS.className = 'quiz-feedback-message mt-4 p-3 rounded-md text-sm';
            }
        }

        function displayQuizFeedback_GS() {
            if (!quizForm_GS || !generalQuizFeedbackDiv_GS) return false;
            const progress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
            const userAnswers = progress.user_quiz_answers || {};
            const submitButton = quizForm_GS.querySelector('button[type="submit"]');

            clearAllVisualFeedback_GS(false);

            if (!progress.quiz_feedback_active && Object.keys(userAnswers).length === 0) {
                quizForm_GS.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
                if (submitButton) {
                    submitButton.textContent = 'Enviar Respuestas';
                    submitButton.disabled = false;
                }
                return false;
            }

            let allCorrect = true;
            let score = 0;

            for (const questionName in quizDataGaussSeidel) {
                const userAnswer = userAnswers[questionName];
                const questionData = quizDataGaussSeidel[questionName];
                const correctAnswer = questionData.correctAnswer;
                const specificFeedbackDiv = document.getElementById(`${questionName}-specific-feedback`);

                const radioInputs = quizForm_GS.querySelectorAll(`input[name="${questionName}"]`);
                radioInputs.forEach(input => {
                    const wrapper = input.closest('.quiz-option-wrapper');
                    const iconPlaceholder = wrapper.querySelector('.feedback-icon-placeholder span');
                    input.disabled = true;
                    wrapper.classList.remove('has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red');

                    if (input.value === userAnswer) {
                        input.checked = true;
                        if (userAnswer === correctAnswer) {
                            wrapper.classList.add('correct-answer-gs', 'border-green-500', 'ring-1', 'ring-green-500', 'bg-green-50');
                            if (iconPlaceholder) iconPlaceholder.textContent = ICON_CORRECT_ANSWER_GS;
                            score++;
                        } else {
                            wrapper.classList.add('incorrect-answer-gs', 'border-red-500', 'ring-1', 'ring-red-500', 'bg-red-50');
                            if (iconPlaceholder) iconPlaceholder.textContent = ICON_INCORRECT_ANSWER_GS;
                            allCorrect = false;
                            if (specificFeedbackDiv && questionData.feedback && questionData.feedback[userAnswer]) {
                                specificFeedbackDiv.innerHTML = "Incorrecto. " + questionData.feedback[userAnswer]; // Use innerHTML for potential MathJax
                                specificFeedbackDiv.style.display = 'block';
                            } else if (specificFeedbackDiv) {
                                specificFeedbackDiv.textContent = "Incorrecto. Respuesta incorrecta.";
                                specificFeedbackDiv.style.display = 'block';
                            }
                        }
                    } else if (input.value === correctAnswer) {
                         wrapper.classList.add('correct-answer-gs', 'border-green-500', 'bg-green-50');
                         if (userAnswer !== correctAnswer && iconPlaceholder) iconPlaceholder.textContent = ICON_THUMB_UP_GS;
                    } else {
                         wrapper.classList.add('border-gray-300');
                    }
                });
            }

            progress.quiz_current_score = score;
            progress.quiz_passed = allCorrect;
            savePageProgressToStorage_GS(PAGE_KEY_GS, progress);

            generalQuizFeedbackDiv_GS.style.display = 'block';
            if (allCorrect) {
                generalQuizFeedbackDiv_GS.className = 'mt-4 p-3 rounded-md text-sm bg-green-100 text-green-700 border border-green-200';
                generalQuizFeedbackDiv_GS.innerHTML = `<strong>¡Felicidades!</strong> Todas tus respuestas son correctas. (${score}/${Object.keys(quizDataGaussSeidel).length})`;
                if (submitButton) {
                    submitButton.textContent = 'Cuestionario Aprobado';
                    submitButton.disabled = true;
                }
            } else {
                generalQuizFeedbackDiv_GS.className = 'mt-4 p-3 rounded-md text-sm bg-red-100 text-red-700 border border-red-200';
                generalQuizFeedbackDiv_GS.innerHTML = `Has respondido correctamente ${score} de ${Object.keys(quizDataGaussSeidel).length} preguntas. Revisa los comentarios e intenta de nuevo.`;
                if (submitButton) {
                    submitButton.textContent = 'Intentar de Nuevo';
                    submitButton.disabled = false;
                }
            }
            if (window.MathJax && window.MathJax.typesetPromise && quizForm_GS) {
                window.MathJax.typesetPromise([quizForm_GS, generalQuizFeedbackDiv_GS]); // Typeset general feedback too
            }
            return allCorrect;
        }

        async function initializePyodide_GS() {
            if (!window.pyodideInstance_GS_Global) {
                if (codeOutput_GS) codeOutput_GS.innerHTML = "<p>Cargando Pyodide y entorno...</p>";
                try {
                    window.pyodideInstance_GS_Global = await window.loadPyodide();
                    await window.pyodideInstance_GS_Global.loadPackage("numpy");
                    window.pyodide_gs_globals = window.pyodideInstance_GS_Global.globals;
                    window.pyodide_gs_globals.set("pyodide_gs_html_output", "");
                    window.pyodide_gs_globals.set("pyodide_gs_chart_data_package", window.pyodideInstance_GS_Global.toPy({}));
                    if (codeOutput_GS) codeOutput_GS.innerHTML = "<p>Pyodide listo. Presiona 'Ejecutar Código'.</p>";
                } catch (error) {
                    console.error("Error al cargar Pyodide para Gauss-Seidel:", error);
                    if (codeOutput_GS) codeOutput_GS.innerHTML = "<p>Error al cargar Pyodide. Revisa la consola.</p>";
                    return null;
                }
            }
            if (!window.pyodide_gs_globals && window.pyodideInstance_GS_Global) {
                 window.pyodide_gs_globals = window.pyodideInstance_GS_Global.globals;
            }
            return window.pyodideInstance_GS_Global;
        }

        async function runCodeNow_GS() {
            pyodide_GS = await initializePyodide_GS();
            if (!pyodide_GS || !window.pyodide_gs_globals) {
                if (codeOutput_GS) codeOutput_GS.innerHTML = "<p>Pyodide no está listo. Intenta recargar.</p>";
                return;
            }
            if (!codeInput_GS || !codeOutput_GS) return;

            const pythonCode = codeInput_GS.value;
            if (codeOutput_GS) codeOutput_GS.innerHTML = "<p>Ejecutando código...</p>";
            gs_d3_opDesc.html("Generando datos para la visualización...");
            gs_d3_svgConvergence.selectAll("*").remove(); // Clear previous D3 convergence plot
            gs_d3_svgError.selectAll("*").remove();      // Clear previous D3 error plot
            gs_d3_legendConvergence.html("");            // Clear legend

            try {
                window.pyodide_gs_globals.set("pyodide_gs_html_output", "");
                let chartPkgProxy = window.pyodide_gs_globals.get("pyodide_gs_chart_data_package");
                if (chartPkgProxy && typeof chartPkgProxy.clear === 'function') chartPkgProxy.clear();
                else window.pyodide_gs_globals.set("pyodide_gs_chart_data_package", pyodide_GS.toPy({}));

                await pyodide_GS.loadPackagesFromImports(pythonCode);
                await pyodide_GS.runPythonAsync(pythonCode);

                const htmlResult = window.pyodide_gs_globals.get("pyodide_gs_html_output");
                if (codeOutput_GS) {
                    codeOutput_GS.innerHTML = htmlResult || "<p>Ejecución completada. No se generó salida HTML de texto.</p>";
                }
                updateTaskStatusInStorage_GS(TASKS_GS.RUN_CODE, true);

                const d3DataPackage = window.pyodide_gs_globals.get("pyodide_gs_chart_data_package").toJs({ dict_converter: Object.fromEntries });
                initializeGSVisualization(d3DataPackage);

            } catch (error) {
                console.error("Error al ejecutar el código Python (Gauss-Seidel):", error);
                if (codeOutput_GS) {
                    codeOutput_GS.innerHTML = `<p style="color:red;">Error en la ejecución: ${error.toString().replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p><pre>${error.stack ? error.stack.replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''}</pre>`;
                }
                gs_d3_opDesc.html("Error al generar datos para la visualización.");
            }
        }

        // --- D3.js Gauss-Seidel Visualization Logic ---
        let gs_d3_currentStepIndex = 0;
        let gs_d3_visualizationData = [];
        let gs_d3_numVariables = 0;
        let gs_d3_isPlaying = false;
        let gs_d3_animationSpeed = 500;
        let gs_d3_playInterval = null;

        const gs_d3_margin = {top: 20, right: 30, bottom: 40, left: 50};
        const gs_d3_svgConvergence = d3.select("#gs-d3-svg-convergence-container");
        const gs_d3_svgError = d3.select("#gs-d3-svg-error-container");
        const gs_d3_legendConvergence = d3.select("#gs-d3-legend-convergence");
        const gs_d3_opDesc = d3.select("#gs-d3-operation-description");
        const gs_d3_tooltip = d3.select(".gs-d3-tooltip");

        const gs_d3_prevButton = d3.select("#gs-d3-prev");
        const gs_d3_nextButton = d3.select("#gs-d3-next");
        const gs_d3_playButton = d3.select("#gs-d3-play");
        const gs_d3_slider = d3.select("#gs-d3-slider");
        const gs_d3_speedSlider = d3.select("#gs-d3-speed");
        const gs_d3_speedValueText = d3.select("#gs-d3-speed-value");
        
        const ICON_GS_PREVIOUS = '<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" class="w-5 h-5"><path d="M15.225 15.077a.75.75 0 01-1.06 0L8.94 9.852a.75.75 0 010-1.06l5.224-5.224a.75.75 0 011.06 1.06L10.532 9.322l4.693 4.695a.75.75 0 010 1.06z"/></svg>';
        const ICON_GS_NEXT = '<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" class="w-5 h-5"><path d="M4.775 4.923a.75.75 0 011.06 0l5.224 5.224a.75.75 0 010 1.06l-5.224 5.224a.75.75 0 01-1.06-1.06L9.468 10.678 4.775 5.983a.75.75 0 010-1.06z"/></svg>';
        const ICON_GS_PLAY = '<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" class="w-5 h-5"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>';
        const ICON_GS_PAUSE = '<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" class="w-5 h-5"><path d="M5.75 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75zm8.5 0a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75z"/></svg>';

        const gs_d3_colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        function initializeGSVisualization(data) {
            gs_d3_svgConvergence.selectAll("*").remove();
            gs_d3_svgError.selectAll("*").remove();
            gs_d3_legendConvergence.html("");

            if (!data || !data.visualization_steps || data.visualization_steps.length === 0) {
                gs_d3_opDesc.html("No hay datos de visualización. Ejecute el código.");
                gs_d3_prevButton.property("disabled", true).html(ICON_GS_PREVIOUS);
                gs_d3_nextButton.property("disabled", true).html(ICON_GS_NEXT);
                gs_d3_slider.property("disabled", true).attr("max",0).property("value",0);
                gs_d3_playButton.property("disabled", true).html(ICON_GS_PLAY);
                return;
            }
            gs_d3_visualizationData = data.visualization_steps;
            gs_d3_numVariables = data.num_variables || (gs_d3_visualizationData[0].x_vector ? gs_d3_visualizationData[0].x_vector.length : 0);
            gs_d3_currentStepIndex = 0;
            gs_d3_isPlaying = false;
            if (gs_d3_playInterval) clearInterval(gs_d3_playInterval);
            
            gs_d3_prevButton.html(ICON_GS_PREVIOUS).property("disabled", false);
            gs_d3_nextButton.html(ICON_GS_NEXT).property("disabled", false);
            gs_d3_playButton.html(ICON_GS_PLAY).property("disabled", false);
            gs_d3_slider.attr("max", gs_d3_visualizationData.length - 1).property("value", 0).property("disabled", false);

            renderGSStep(gs_d3_currentStepIndex);
            updateGSControls();
        }

        function renderGSStep(stepIndex) {
            if (stepIndex < 0 || stepIndex >= gs_d3_visualizationData.length) return;
            const currentStepData = gs_d3_visualizationData[stepIndex];
            gs_d3_opDesc.html(currentStepData.description || `Iteración ${currentStepData.iteration}`);
            gs_d3_slider.property("value", stepIndex);

            const dataToShow = gs_d3_visualizationData.slice(0, stepIndex + 1);

            // --- Convergence Plot (x_i values) ---
            const convWidth = gs_d3_svgConvergence.node().getBoundingClientRect().width - gs_d3_margin.left - gs_d3_margin.right;
            const convHeight = gs_d3_svgConvergence.node().getBoundingClientRect().height - gs_d3_margin.top - gs_d3_margin.bottom;
            
            gs_d3_svgConvergence.selectAll("*").remove(); // Clear previous
            const convG = gs_d3_svgConvergence.append("g").attr("transform", `translate(${gs_d3_margin.left},${gs_d3_margin.top})`);

            const xScaleConv = d3.scaleLinear()
                .domain([0, d3.max(gs_d3_visualizationData, d => d.iteration)])
                .range([0, convWidth]);

            const allXValues = gs_d3_visualizationData.flatMap(d => d.x_vector || []);
            const yMinConv = d3.min(allXValues);
            const yMaxConv = d3.max(allXValues);
            
            const yScaleConv = d3.scaleLinear()
                .domain([ (yMinConv !== undefined && yMinConv < 0) ? yMinConv * 1.1 : (yMinConv !== undefined ? yMinConv * 0.9 : -1), 
                          (yMaxConv !== undefined && yMaxConv > 0) ? yMaxConv * 1.1 : (yMaxConv !== undefined ? yMaxConv * 0.9 : 1) ])
                .range([convHeight, 0]).nice();

            convG.append("g").attr("class", "axis axis--x")
                .attr("transform", `translate(0,${convHeight})`)
                .call(d3.axisBottom(xScaleConv).ticks(Math.min(10, gs_d3_visualizationData.length-1)).tickFormat(d3.format("d")));
            convG.append("g").attr("class", "axis axis--y").call(d3.axisLeft(yScaleConv).ticks(5));

            gs_d3_legendConvergence.html(""); // Clear and rebuild legend
            for (let i = 0; i < gs_d3_numVariables; i++) {
                const line = d3.line()
                    .x(d => xScaleConv(d.iteration))
                    .y(d => yScaleConv(d.x_vector[i]));
                
                convG.append("path").datum(dataToShow.filter(d => d.x_vector && d.x_vector.length > i))
                    .attr("class", "line")
                    .attr("fill", "none")
                    .attr("stroke", gs_d3_colorScale(i))
                    .attr("stroke-width", 1.5)
                    .attr("d", line);

                // Add to legend
                const legendItem = gs_d3_legendConvergence.append("div").attr("class", "gs-d3-legend-item");
                legendItem.append("div").attr("class", "gs-d3-legend-color").style("background-color", gs_d3_colorScale(i));
                legendItem.append("span").text(`x${i+1}`);
            }
             // Current iteration marker line for convergence plot
            convG.selectAll(".current-iter-marker-conv").remove();
            convG.append("line")
                .attr("class", "current-iter-marker-conv")
                .attr("x1", xScaleConv(currentStepData.iteration))
                .attr("x2", xScaleConv(currentStepData.iteration))
                .attr("y1", 0)
                .attr("y2", convHeight)
                .attr("stroke", "grey")
                .attr("stroke-width", 1.5)
                .attr("stroke-dasharray", "4 2");


            // --- Error Plot ---
            const errorWidth = gs_d3_svgError.node().getBoundingClientRect().width - gs_d3_margin.left - gs_d3_margin.right;
            const errorHeight = gs_d3_svgError.node().getBoundingClientRect().height - gs_d3_margin.top - gs_d3_margin.bottom;

            gs_d3_svgError.selectAll("*").remove(); // Clear previous
            const errorG = gs_d3_svgError.append("g").attr("transform", `translate(${gs_d3_margin.left},${gs_d3_margin.top})`);

            const dataWithError = dataToShow.filter(d => d.error !== null && d.error !== undefined && !isNaN(d.error) && d.iteration > 0);

            const xScaleError = d3.scaleLinear()
                .domain([1, d3.max(gs_d3_visualizationData, d => d.iteration) || 1]) // Start error plot from iteration 1
                .range([0, errorWidth]);

            const yMinError = d3.min(gs_d3_visualizationData, d => (d.error !== null && d.error !== undefined && d.iteration > 0) ? d.error : undefined );
            const yMaxError = d3.max(gs_d3_visualizationData, d => (d.error !== null && d.error !== undefined && d.iteration > 0) ? d.error : undefined );
            
            const yScaleError = d3.scaleLog() // Use log scale for error
                .domain([ Math.max(1e-12, yMinError || 1e-12), Math.max(1, yMaxError || 1) ])
                .range([errorHeight, 0]).nice();

            errorG.append("g").attr("class", "axis axis--x")
                .attr("transform", `translate(0,${errorHeight})`)
                .call(d3.axisBottom(xScaleError).ticks(Math.min(10, gs_d3_visualizationData.length-1)).tickFormat(d3.format("d")));
            errorG.append("g").attr("class", "axis axis--y")
                .call(d3.axisLeft(yScaleError).ticks(5, ".1e")); // Format for scientific notation

            if (dataWithError.length > 0) {
                const errorLine = d3.line()
                    .x(d => xScaleError(d.iteration))
                    .y(d => yScaleError(d.error));

                errorG.append("path").datum(dataWithError)
                    .attr("class", "line")
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("d", errorLine);
            }
             // Current iteration marker line for error plot
            errorG.selectAll(".current-iter-marker-error").remove();
            errorG.append("line")
                .attr("class", "current-iter-marker-error")
                .attr("x1", xScaleError(currentStepData.iteration))
                .attr("x2", xScaleError(currentStepData.iteration))
                .attr("y1", 0)
                .attr("y2", errorHeight)
                .attr("stroke", "grey")
                .attr("stroke-width", 1.5)
                .attr("stroke-dasharray", "4 2");

            updateGSControls();
        }

        function updateGSControls() {
            gs_d3_prevButton.property("disabled", gs_d3_currentStepIndex <= 0);
            gs_d3_nextButton.property("disabled", gs_d3_currentStepIndex >= gs_d3_visualizationData.length - 1);
            gs_d3_slider.property("value", gs_d3_currentStepIndex);
            gs_d3_playButton.property("disabled", gs_d3_visualizationData.length === 0);
        }
        function stopGSPlayback() {
            gs_d3_isPlaying = false;
            clearInterval(gs_d3_playInterval);
            gs_d3_playButton.html(ICON_GS_PLAY).attr("aria-label", "Play");
        }

        gs_d3_prevButton.on("click", () => {
            if (gs_d3_isPlaying) stopGSPlayback();
            if (gs_d3_currentStepIndex > 0) {
                gs_d3_currentStepIndex--;
                renderGSStep(gs_d3_currentStepIndex);
            }
        });

        gs_d3_nextButton.on("click", () => {
            if (gs_d3_isPlaying) stopGSPlayback();
            if (gs_d3_currentStepIndex < gs_d3_visualizationData.length - 1) {
                gs_d3_currentStepIndex++;
                renderGSStep(gs_d3_currentStepIndex);
            }
        });
        gs_d3_playButton.on("click", () => {
            if (gs_d3_visualizationData.length === 0) return;
            gs_d3_isPlaying = !gs_d3_isPlaying;
            if (gs_d3_isPlaying) {
                gs_d3_playButton.html(ICON_GS_PAUSE).attr("aria-label", "Pause");
                if (gs_d3_currentStepIndex >= gs_d3_visualizationData.length - 1) {
                    gs_d3_currentStepIndex = -1; 
                }
                gs_d3_playInterval = setInterval(() => {
                    if (gs_d3_currentStepIndex < gs_d3_visualizationData.length - 1) {
                        gs_d3_currentStepIndex++;
                        renderGSStep(gs_d3_currentStepIndex);
                    } else {
                        stopGSPlayback();
                    }
                }, gs_d3_animationSpeed + 50); // Add a small buffer
            } else {
                stopGSPlayback();
            }
        });

        gs_d3_slider.on("input", function() {
            if (gs_d3_isPlaying) stopGSPlayback();
            gs_d3_currentStepIndex = +this.value;
            renderGSStep(gs_d3_currentStepIndex);
        });

        gs_d3_speedSlider.on("input", function() {
            gs_d3_animationSpeed = +this.value;
            gs_d3_speedValueText.text(`${gs_d3_animationSpeed}ms`);
            if (gs_d3_isPlaying) { // If playing, restart with new speed
                stopGSPlayback();
                gs_d3_playButton.dispatch("click"); 
            }
        });
        gs_d3_speedValueText.text(`${gs_d3_speedSlider.property("value")}ms`);


        if (runCodeButton_GS) runCodeButton_GS.addEventListener('click', runCodeNow_GS);

        if (quizForm_GS) {
            quizForm_GS.addEventListener('submit', function(event) {
                event.preventDefault();
                const currentLocalProgress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
                const submitButton = quizForm_GS.querySelector('button[type="submit"]');

                if (currentLocalProgress[TASKS_GS.QUIZ_PASSED] && submitButton.textContent !== 'Intentar de Nuevo') return;

                if (submitButton && submitButton.textContent === 'Intentar de Nuevo') {
                    quizForm_GS.reset();
                    clearAllVisualFeedback_GS(true);
                    if(generalQuizFeedbackDiv_GS) generalQuizFeedbackDiv_GS.style.display = 'none';

                    let progressToSave = getPageProgressFromStorage_GS(PAGE_KEY_GS);
                    progressToSave.user_quiz_answers = {};
                    progressToSave.quiz_current_score = 0;
                    progressToSave.quiz_feedback_active = false;
                    savePageProgressToStorage_GS(PAGE_KEY_GS, progressToSave);
                    updateTaskStatusInStorage_GS(TASKS_GS.QUIZ_PASSED, false);

                    quizForm_GS.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
                     quizForm_GS.querySelectorAll('.quiz-option-wrapper').forEach(wrapper => {
                         wrapper.classList.add('has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red');
                    });
                    submitButton.textContent = 'Enviar Respuestas';
                    return;
                }

                const formData = new FormData(quizForm_GS);
                let allAnswered = true;
                for (const qName of Object.keys(quizDataGaussSeidel)) { if (!formData.has(qName)) { allAnswered = false; break; } }

                if (!allAnswered) {
                    if (generalQuizFeedbackDiv_GS) {
                        generalQuizFeedbackDiv_GS.textContent = "Por favor, responde todas las preguntas.";
                        generalQuizFeedbackDiv_GS.className = 'mt-4 p-3 rounded-md text-sm bg-yellow-100 text-yellow-700 border border-yellow-200';
                        generalQuizFeedbackDiv_GS.style.display = 'block';
                    } return;
                }

                updateTaskStatusInStorage_GS(TASKS_GS.QUIZ_ATTEMPTED, true);

                let progress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
                progress.user_quiz_answers = {};
                for (const qName of Object.keys(quizDataGaussSeidel)) { progress.user_quiz_answers[qName] = formData.get(qName); }
                progress.quiz_feedback_active = true;
                savePageProgressToStorage_GS(PAGE_KEY_GS, progress);

                const quizWasPassed = displayQuizFeedback_GS();
                updateTaskStatusInStorage_GS(TASKS_GS.QUIZ_PASSED, quizWasPassed);
                calculateAndUpdateOverallProgress_GS();
            });
        }

        if (mainCompletionButton_GS) {
             mainCompletionButton_GS.addEventListener('click', () => {
                const progress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
                let allCurrentlyCompleted = ALL_TASK_KEYS_GS.every(taskKey => progress[taskKey]);
                let markAllAs = !allCurrentlyCompleted;

                ALL_TASK_KEYS_GS.forEach(taskName => updateTaskStatusInStorage_GS(taskName, markAllAs));

                let updatedProgress = getPageProgressFromStorage_GS(PAGE_KEY_GS);
                if (!markAllAs) { // Resetting
                    updatedProgress.user_quiz_answers = {};
                    updatedProgress.quiz_current_score = 0;
                    updatedProgress.quiz_feedback_active = false;
                    if (quizForm_GS) {
                        quizForm_GS.reset();
                        quizForm_GS.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = false);
                        const sb = quizForm_GS.querySelector('button[type="submit"]');
                        if(sb) sb.textContent = 'Enviar Respuestas';
                        quizForm_GS.querySelectorAll('.quiz-option-wrapper').forEach(w => w.classList.add('has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red'));

                    }
                    clearAllVisualFeedback_GS(true);
                } else { // Marking all as complete
                     updatedProgress[TASKS_GS.QUIZ_ATTEMPTED] = true;
                     updatedProgress[TASKS_GS.QUIZ_PASSED] = true;
                    // Auto-fill correct answers if marking all complete and quiz wasn't already 'passed' this way
                    if (Object.keys(updatedProgress.user_quiz_answers).length === 0) { // Or check if score wasn't max
                        for (const qName in quizDataGaussSeidel) updatedProgress.user_quiz_answers[qName] = quizDataGaussSeidel[qName].correctAnswer;
                        updatedProgress.quiz_current_score = Object.keys(quizDataGaussSeidel).length;
                    }
                    updatedProgress.quiz_feedback_active = true; // Ensure feedback shows
                }
                savePageProgressToStorage_GS(PAGE_KEY_GS, updatedProgress);

                if (quizForm_GS) displayQuizFeedback_GS();
                calculateAndUpdateOverallProgress_GS();

                if (generalQuizFeedbackDiv_GS && !markAllAs) generalQuizFeedbackDiv_GS.style.display = 'none';
                alert(markAllAs ? 'Todas las tareas marcadas como completadas.' : 'Se ha deshecho el completado.');
            });
        }

        const theorySectionObserverTargetNodeGS = document.getElementById('conclusion-gs') || document.getElementById('teoria-gs');
        if (theorySectionObserverTargetNodeGS) {
            const observerOptionsGS = { root: null, rootMargin: '0px', threshold: 0.1 };
            const observerCallbackGS = (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) updateTaskStatusInStorage_GS(TASKS_GS.READ_THEORY, true);
                });
            };
            const theoryObserver_GS = new IntersectionObserver(observerCallbackGS, observerOptionsGS);
            theoryObserver_GS.observe(theorySectionObserverTargetNodeGS);
        }

        if (window.location.hash) history.replaceState(null, '', window.location.pathname + window.location.search);

        (async () => {
            pyodide_GS = await initializePyodide_GS();
            initializeGSVisualization(null); // Initialize D3 with null data
        })();

        // Initial load of quiz state and progress
        const initialProgress_GS = getPageProgressFromStorage_GS(PAGE_KEY_GS);
        if (initialProgress_GS.quiz_feedback_active || (initialProgress_GS[TASKS_GS.QUIZ_ATTEMPTED] && Object.keys(initialProgress_GS.user_quiz_answers).length > 0) ) {
            if (quizForm_GS && initialProgress_GS.user_quiz_answers) {
                 for (const qName in initialProgress_GS.user_quiz_answers) {
                    const userAnswer = initialProgress_GS.user_quiz_answers[qName];
                    const escapedUserAnswer = userAnswer.replace(/([\\()\[\]"'])/g, '\\$1'); // Basic escape for querySelector
                    try {
                        const radioToSelect = quizForm_GS.querySelector(`input[name="${qName}"][value="${escapedUserAnswer}"]`);
                        if (radioToSelect) radioToSelect.checked = true;
                    } catch (e) { console.warn(`Error seleccionando radio GS para ${qName}`, e); }
                }
            }
            displayQuizFeedback_GS();
        } else if (quizForm_GS) { // No previous attempt, or reset
            const submitButton = quizForm_GS.querySelector('button[type="submit"]');
            if (submitButton) { submitButton.textContent = 'Enviar Respuestas'; submitButton.disabled = false; }
            quizForm_GS.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
             quizForm_GS.querySelectorAll('.quiz-option-wrapper').forEach(wrapper => wrapper.classList.add('has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red'));
            if (window.MathJax && window.MathJax.typesetPromise) window.MathJax.typesetPromise([quizForm_GS]);
        }
        calculateAndUpdateOverallProgress_GS();

        // Fullscreen and font size for code output (same as Gauss-Jordan, adapted for GS IDs)
        if (fullscreenButton_GS && codeOutput_GS && outputControlsContainer_GS) {
             fullscreenButton_GS.addEventListener('click', () => {
                const isFullscreen = codeOutput_GS.classList.contains('gs-output-fullscreen');
                if (isFullscreen) { // To normal
                    outputControlsContainer_GS.style.opacity = '0';
                    if(increaseFontButton_GS) increaseFontButton_GS.style.display = 'none';
                    if(decreaseFontButton_GS) decreaseFontButton_GS.style.display = 'none';
                    if (gsCodeOutputInitialRect) { // Animate back
                        const finalRect = codeOutput_GS.getBoundingClientRect();
                        const scaleX = gsCodeOutputInitialRect.width / finalRect.width;
                        const scaleY = gsCodeOutputInitialRect.height / finalRect.height;
                        const deltaX = (gsCodeOutputInitialRect.left + gsCodeOutputInitialRect.width / 2) - (finalRect.left + finalRect.width / 2);
                        const deltaY = (gsCodeOutputInitialRect.top + gsCodeOutputInitialRect.height / 2) - (finalRect.top + finalRect.height / 2);
                        codeOutput_GS.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
                     }
                    setTimeout(() => {
                        codeOutput_GS.style.transition = 'none'; // Disable transition for instant reset
                        codeOutput_GS.classList.remove('gs-output-fullscreen');
                        document.body.classList.remove('gs-body-fullscreen-active');
                        outputControlsContainer_GS.classList.remove('gs-output-controls-container-fixed');
                        outputControlsContainer_GS.style.transition = 'none'; outputControlsContainer_GS.style.opacity = '1'; // Reset controls visibility
                        outputControlsContainer_GS.offsetHeight; outputControlsContainer_GS.style.transition = ''; // Re-enable for future
                        codeOutput_GS.style.transform = ''; // Reset transform
                        if (originalOutputFontSize_GS) codeOutput_GS.style.fontSize = originalOutputFontSize_GS;
                        codeOutput_GS.offsetHeight; codeOutput_GS.style.transition = ''; // Re-enable transition for future changes
                        fullscreenButton_GS.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9m5.25 11.25v-4.5m0 4.5h-4.5m4.5 0L15 15" /></svg>`;
                        fullscreenButton_GS.title = "Ver en pantalla completa"; gsCodeOutputInitialRect = null;
                    }, 500); // Duration of animation
                } else { // To fullscreen
                    originalOutputFontSize_GS = window.getComputedStyle(codeOutput_GS).fontSize;
                    gsCodeOutputInitialRect = codeOutput_GS.getBoundingClientRect(); // Store initial state
                    outputControlsContainer_GS.style.transition = 'none'; outputControlsContainer_GS.style.opacity = '0';
                    outputControlsContainer_GS.offsetHeight; outputControlsContainer_GS.style.transition = '';
                    codeOutput_GS.style.transition = 'none'; // Disable transition for instant class change
                    codeOutput_GS.classList.add('gs-output-fullscreen');
                    document.body.classList.add('gs-body-fullscreen-active');
                    outputControlsContainer_GS.classList.add('gs-output-controls-container-fixed');
                    // Animate from initial state
                    const finalRect = codeOutput_GS.getBoundingClientRect();
                    const scaleX = gsCodeOutputInitialRect.width / finalRect.width;
                    const scaleY = gsCodeOutputInitialRect.height / finalRect.height;
                    const deltaX = (gsCodeOutputInitialRect.left + gsCodeOutputInitialRect.width / 2) - (finalRect.left + finalRect.width / 2);
                    const deltaY = (gsCodeOutputInitialRect.top + gsCodeOutputInitialRect.height / 2) - (finalRect.top + finalRect.height / 2);
                    codeOutput_GS.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
                    codeOutput_GS.offsetHeight; // Trigger reflow
                    codeOutput_GS.style.transition = ''; // Re-enable transition for animation
                    codeOutput_GS.style.transform = 'translate(0px, 0px) scale(1)'; // Animate to fullscreen
                    fullscreenButton_GS.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9V4.5M15 9h4.5M15 9l5.25-5.25M15 15v4.5M15 15h4.5M15 15l5.25 5.25" /></svg>`;
                    fullscreenButton_GS.title = "Salir de pantalla completa";
                    setTimeout(() => { // Make controls visible after animation starts
                        outputControlsContainer_GS.style.opacity = '1';
                        if(increaseFontButton_GS) increaseFontButton_GS.style.display = 'inline-flex';
                        if(decreaseFontButton_GS) decreaseFontButton_GS.style.display = 'inline-flex';
                    }, 500);
                }
            });
        }
        if (increaseFontButton_GS && codeOutput_GS) {
            increaseFontButton_GS.addEventListener('click', () => {
                if (codeOutput_GS.classList.contains('gs-output-fullscreen')) {
                    let currentSize = parseFloat(window.getComputedStyle(codeOutput_GS).fontSize);
                    if (currentSize < MAX_FONT_SIZE_PX_GS) {
                        codeOutput_GS.style.fontSize = (currentSize + FONT_SIZE_STEP_PX_GS) + 'px';
                        increaseFontButton_GS.classList.add('gs-font-button-flash-blue');
                        setTimeout(() => { increaseFontButton_GS.classList.remove('gs-font-button-flash-blue'); }, 400);
                    }
                }
            });
        }
        if (decreaseFontButton_GS && codeOutput_GS) {
             decreaseFontButton_GS.addEventListener('click', () => {
                if (codeOutput_GS.classList.contains('gs-output-fullscreen')) {
                    let currentSize = parseFloat(window.getComputedStyle(codeOutput_GS).fontSize);
                    if (currentSize > MIN_FONT_SIZE_PX_GS) {
                        codeOutput_GS.style.fontSize = (currentSize - FONT_SIZE_STEP_PX_GS) + 'px';
                        decreaseFontButton_GS.classList.add('gs-font-button-flash-red');
                        setTimeout(() => { decreaseFontButton_GS.classList.remove('gs-font-button-flash-red'); }, 400);
                    }
                }
            });
        }
        // Initially hide font buttons if not in fullscreen (they only work in fullscreen for now)
        if(increaseFontButton_GS) increaseFontButton_GS.style.display = 'none';
        if(decreaseFontButton_GS) decreaseFontButton_GS.style.display = 'none';


    });
    </script>

    <!-- Vue App Initialization Script -->
    <script type="module">
        const { createApp, ref, onMounted, onUnmounted, watch, nextTick } = Vue;
        const LeftSidebarGS = {
            template: `{% raw %}
                <aside 
                    :class="[
                        'bg-gradient-to-b from-red-500 to-red-700', 'shadow-xl', 'rounded-lg', 'p-4',
                        'flex', 'flex-col',
                        'transition-all', 'duration-300', 'ease-in-out',
                        'order-1', 
                        isCollapsed ? 'w-full lg:w-20' : 'w-full lg:w-64',
                        'self-start', 
                        'lg:sticky', 'lg:top-8', 
                        'lg:max-h-[calc(100vh-4rem)]', 
                        'overflow-y-auto'
                    ]"
                    aria-label="Sidebar de navegación del método">
                    <div class="flex justify-between items-center mb-4 border-b border-red-400 pb-3">
                        <h3 v-show="!isCollapsed" class="text-lg font-semibold text-white select-none">Contenido</h3>
                        <button @click="toggleCollapse" class="p-1.5 ml-2 text-white hover:bg-red-700 rounded focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-75" :aria-label="isCollapsed ? 'Expandir menú' : 'Colapsar menú'">
                            <svg v-if="!isCollapsed" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M18.75 19.5l-7.5-7.5 7.5-7.5m-6 15L5.25 12l7.5-7.5" /></svg>
                            <svg v-else xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" /></svg>
                        </button>
                    </div>
                    <nav v-show="!isCollapsed">
                        <ul class="space-y-1">
                            <li v-for="item in navItems" :key="item.id">
                                <a :href="item.href" @click.prevent="smoothScroll(item.href)"
                                   :class="['nav-link block px-4 py-2 rounded-md text-sm font-medium transition-colors duration-150 flex items-center', isActive(item.id) ? 'bg-white text-custom-blue font-semibold shadow-sm' : 'text-red-100 hover:bg-red-700 hover:text-white']">
                                    <span v-html="item.iconSVG" class="mr-3 translate-y-px"></span>
                                    <span>{{ item.text }}</span>
                                </a></li></ul></nav>
                    <nav v-show="isCollapsed" class="mt-4">
                         <ul class="space-y-1">
                            <li v-for="item in navItems" :key="item.id + '-collapsed'">
                                <a :href="item.href" @click.prevent="smoothScroll(item.href)" :title="item.text" :aria-label="item.text"
                                   :class="['nav-link-collapsed block py-2 pl-2.5 pr-1.5 rounded-md transition-colors duration-150 flex justify-center items-center', isActive(item.id) ? 'bg-white text-custom-blue shadow-sm' : 'text-red-100 hover:bg-red-700 hover:text-white']">
                                    <span v-html="item.iconSVG" class="w-6 h-6 translate-y-px"></span>
                                </a></li></ul></nav></aside>{% endraw %}`,
            setup() {
                const isCollapsed = ref(false);
                const activeSectionId = ref('teoria-gs'); // Default for Gauss-Seidel
                const navItems = ref([ // Update for Gauss-Seidel sections
                    { id: 'teoria-gs', text: 'Fundamento Teórico', href: '#teoria-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>' },
                    { id: 'algoritmo-gs', text: 'Pasos del Algoritmo', href: '#algoritmo-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>' },
                    { id: 'ejemplo-gs', text: 'Ejemplo Detallado', href: '#ejemplo-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>' },
                    { id: 'codigo-gs', text: 'Implementación (Python)', href: '#codigo-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" /></svg>' },
                    { id: 'graficas-gs', text: 'Visualización Interactiva', href: '#graficas-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" /></svg>' }, // Line chart icon
                    { id: 'videos-gs', text: 'Videos Explicativos', href: '#videos-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.75.75 0 010 1.656l-5.603 3.113A.75.75 0 019 15.95V9.05a.75.75 0 011.307-.588l5.603 3.112z" /></svg>' },
                    { id: 'conclusion-gs', text: 'Conclusión', href: '#conclusion-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>' },
                    { id: 'referencias-gs', text: 'Referencias', href: '#referencias-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25L7.5 16.5V3.75m9 0H18A2.25 2.25 0 0120.25 6v12A2.25 2.25 0 0118 20.25H6A2.25 2.25 0 013.75 18V6A2.25 2.25 0 016 3.75h1.5m9 0h-9" /></svg>' },
                    { id: 'cuestionario-gs', text: 'Cuestionario', href: '#cuestionario-gs', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>' }
                ]);
                let sections = [];
                const toggleCollapse = () => isCollapsed.value = !isCollapsed.value;
                const isActive = (id) => activeSectionId.value === id;
                const smoothScroll = (targetHref) => {
                    const targetId = targetHref.substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: "smooth", block: "start" });
                        history.pushState(null, null, targetHref); // Update URL without page reload for active section tracking
                    }
                };
                const handleScroll = () => { // Logic to update activeSectionId based on scroll position
                    if (!sections.length) return;
                    const scrollMarginTopValue = parseInt(getComputedStyle(sections[0]).scrollMarginTop) || 96; // Standard scroll margin
                    let newActiveSectionId = null;

                    for (let i = 0; i < sections.length; i++) {
                        const section = sections[i];
                        const sectionTopBoundary = section.offsetTop - scrollMarginTopValue;
                        const sectionBottomBoundary = sectionTopBoundary + section.offsetHeight;
                        if (window.scrollY >= sectionTopBoundary && window.scrollY < sectionBottomBoundary) {
                            newActiveSectionId = section.id;
                            break;
                        }
                    }
                    if (newActiveSectionId === null) { // If no section is actively in view (e.g., scrolled past all or before first)
                        // Check if scrolled to the very top or very bottom
                        if (window.scrollY < (sections[0].offsetTop - scrollMarginTopValue)) {
                            newActiveSectionId = sections[0].id;
                        } else if (window.scrollY + window.innerHeight >= document.documentElement.scrollHeight - 50) { // Near bottom
                             newActiveSectionId = sections[sections.length-1].id;
                        } else { // Fallback if in between but not perfectly hitting a section
                             for (let i = sections.length - 1; i >= 0; i--) {
                                if ((sections[i].offsetTop - scrollMarginTopValue) <= window.scrollY + 5) { // +5 for small offset
                                    newActiveSectionId = sections[i].id; break;
                                }
                            }
                        }
                    }
                     if (activeSectionId.value !== newActiveSectionId && newActiveSectionId !== null) {
                        activeSectionId.value = newActiveSectionId;
                    }
                };
                onMounted(() => {
                    nextTick(() => { // Ensure DOM is fully rendered
                        sections = Array.from(document.querySelectorAll('main article section[id]'));
                        handleScroll(); // Initial check
                        window.addEventListener('scroll', handleScroll, { passive: true });
                    });
                });
                onUnmounted(() => window.removeEventListener('scroll', handleScroll));
                return { isCollapsed, toggleCollapse, navItems, isActive, smoothScroll, activeSectionId };
            }
        };
        const appGS = createApp({
            setup() {
                const METHOD_KEY_GS_VUE = "gauss-seidel";
                const METHOD_NAME_TITLE_CASE_GS_VUE = "Gauss-Seidel";
                return { METHOD_KEY_GS_VUE, METHOD_NAME_TITLE_CASE_GS_VUE };
            }
        });
        appGS.component('left-sidebar-gs', LeftSidebarGS);
        appGS.config.compilerOptions.isCustomElement = tag => tag.startsWith('mjx-');
        appGS.mount('#app-gs');
    </script>
</body>
</html>