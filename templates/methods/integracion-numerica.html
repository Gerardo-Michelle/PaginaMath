<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integración Numérica - Métodos Numéricos</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- <link rel="stylesheet" href="../style.css"> --> <!-- Comentado para priorizar Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script> <!-- Tailwind CSS CDN -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Establecer Inter como fuente sans por defecto
                    },
                    colors: {
                        'custom-blue': '#242A38',
                        'custom-red': '#E94560',
                        'custom-gray-bg': '#F3F4F6',
                        'sidebar-bg': '#FFFFFF',
                        'sidebar-text': '#4B5563',
                        'sidebar-hover-bg': '#FEF2F2',
                    }
                }
            }
        }
    </script>
    <!-- Configuración de MathJax -->
    <script>
        window.MathJax = {
            tex: {
                packages: {'[+]': ['input/mml', 'output/chtml']}
            },
            chtml: {
                matchFontHeight: false
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Pyodide y Chart.js -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @keyframes animatedRainbowBorder {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }
        .animate-rainbow-border::before {
            content: ''; position: absolute; z-index: -1; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 9999px;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #007bff, #8a2be2, #ff00ff, #ff0000);
            background-size: 200% 100%;
            animation: animatedRainbowBorder 3s linear infinite;
        }
        .animate-rainbow-border { position: relative; z-index: 0; }

        /* Styles for fullscreen code output - Integracion Numerica */
        .intnum-output-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9990 !important;
            background-color: #111827 !important; /* bg-gray-900 */
            padding: 20px !important;
            margin: 0 !important;
            border-radius: 0 !important;
            overflow-y: auto !important;
            max-height: 100vh !important;
        }
        .intnum-body-fullscreen-active {
            overflow: hidden !important;
        }
        .intnum-output-controls-container-fixed {
            position: fixed !important;
            top: 15px !important;
            right: 15px !important;
            z-index: 9999 !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.25rem !important; /* space-x-1 */
        }

        /* Flash animations for font buttons - Integracion Numerica */
        .intnum-font-button-flash-red {
            animation: intnum-flash-red 0.4s ease-out;
        }
        @keyframes intnum-flash-red {
            0% { background-color: #EF4444; } /* red-500 */
            100% { background-color: #374151; } /* gray-700, original button color */
        }
        .intnum-font-button-flash-blue {
            animation: intnum-flash-blue 0.4s ease-out;
        }
        @keyframes intnum-flash-blue {
            0% { background-color: #3B82F6; } /* blue-500 */
            100% { background-color: #374151; } /* gray-700, original button color */
        }
        /* Styles for quiz options */
        .quiz-option-wrapper.correct-answer-intnum {
            border-color: #22C55E; /* green-500 */
            background-color: #F0FDF4; /* green-50 */
        }
        .quiz-option-wrapper.incorrect-answer-intnum {
            border-color: #EF4444; /* red-500 */
            background-color: #FEF2F2; /* red-50 */
        }
    </style>
</head>
<body class="bg-custom-gray-bg text-gray-700 font-sans antialiased">
    <div id="app">
        <header class="bg-custom-blue text-white shadow-md">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-xl font-semibold"><a href="../index.html" class="hover:text-gray-300">Métodos Numéricos</a></h1>
                <nav><a href="../index.html#method-cards-container" class="text-sm px-4 py-2 rounded-md hover:bg-gray-700 transition-colors duration-150">Volver a Métodos</a></nav>
            </div>
        </header>

        <div class="container mx-auto mt-8 mb-8 flex flex-col lg:flex-row lg:space-x-8 px-4">
            <left-sidebar></left-sidebar>
            <main class="w-full flex-1 min-w-0 bg-white shadow-xl rounded-lg p-6 md:p-8 order-2 mb-6 lg:mb-0">
                <article class="method-content">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b border-gray-200 pb-4">Integración Numérica (Trapecio, Simpson)</h2>

                    <section id="teoria" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Fundamento Teórico</h3>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            La integración numérica, también conocida como cuadratura numérica, es el proceso de calcular una aproximación al valor de una integral definida:
                        </p>
                        <p style="text-align:center;" class="my-3">\(I = \int_{a}^{b} f(x) dx\)</p>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            Estos métodos son esenciales cuando la integral no puede ser resuelta analíticamente (es decir, no se puede encontrar una primitiva elemental) o cuando la función \(f(x)\) solo se conoce a través de un conjunto de puntos de datos discretos. Los métodos más comunes se basan en aproximar \(f(x)\) con un polinomio de interpolación y luego integrar este polinomio.
                        </p>

                        <h4 class="text-xl font-semibold mt-6 mb-3 text-gray-700">1. Regla del Trapecio</h4>
                        <p class="text-gray-600 leading-relaxed mb-3">
                            La regla del trapecio aproxima el área bajo la curva \(f(x)\) en un intervalo \([x_0, x_1]\) mediante un trapecio formado por los puntos \((x_0, f(x_0))\), \((x_1, f(x_1))\), \((x_0, 0)\), y \((x_1, 0)\).
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-1 font-medium">Fórmula Simple (un segmento):</p>
                        <p style="text-align:center;" class="my-2">\(I \approx \frac{h}{2} [f(x_0) + f(x_1)]\)</p>
                        <p class="text-gray-600 leading-relaxed mb-3">donde \(h = x_1 - x_0\). El error de truncamiento local es de orden \(O(h^3)\).</p>
                        <p class="text-gray-600 leading-relaxed mb-1 font-medium">Fórmula Compuesta (múltiples segmentos):</p>
                        <p class="text-gray-600 leading-relaxed mb-3">Para \(n\) segmentos de igual ancho \(h = (b-a)/n\):</p>
                        <p style="text-align:center;" class="my-2">\(I \approx \frac{h}{2} [f(x_0) + 2\sum_{i=1}^{n-1} f(x_i) + f(x_n)]\)</p>
                        <p class="text-gray-600 leading-relaxed mb-4">El error de truncamiento global es de orden \(O(h^2)\) (o \(O(1/n^2)\)).</p>

                        <h4 class="text-xl font-semibold mt-6 mb-3 text-gray-700">2. Regla de Simpson 1/3</h4>
                        <p class="text-gray-600 leading-relaxed mb-3">
                            La regla de Simpson 1/3 aproxima la función \(f(x)\) usando un polinomio de segundo grado (una parábola) que pasa por tres puntos equiespaciados: \((x_0, f(x_0))\), \((x_1, f(x_1))\), y \((x_2, f(x_2))\).
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-1 font-medium">Fórmula Simple (dos segmentos, tres puntos):</p>
                        <p class="text-gray-600 leading-relaxed mb-3">El intervalo de integración es \([x_0, x_2]\), con \(x_1\) como punto medio. Sea \(h = (x_2-x_0)/2\).</p>
                        <p style="text-align:center;" class="my-2">\(I \approx \frac{h}{3} [f(x_0) + 4f(x_1) + f(x_2)]\)</p>
                        <p class="text-gray-600 leading-relaxed mb-3">El error de truncamiento local es de orden \(O(h^5)\).</p>
                        <p class="text-gray-600 leading-relaxed mb-1 font-medium">Fórmula Compuesta:</p>
                        <p class="text-gray-600 leading-relaxed mb-3">Requiere un número <strong>par</strong> de segmentos \(n\) (es decir, \(n+1\) puntos, donde \(n\) es par). Sea \(h = (b-a)/n\).</p>
                        <p style="text-align:center;" class="my-2">\(I \approx \frac{h}{3} [f(x_0) + 4\sum_{i=1,3,5,...}^{n-1} f(x_i) + 2\sum_{i=2,4,6,...}^{n-2} f(x_i) + f(x_n)]\)</p>
                        <p class="text-gray-600 leading-relaxed mb-4">El error de truncamiento global es de orden \(O(h^4)\) (o \(O(1/n^4)\)).</p>

                        <h4 class="text-xl font-semibold mt-6 mb-3 text-gray-700">3. Regla de Simpson 3/8</h4>
                        <p class="text-gray-600 leading-relaxed mb-3">
                            La regla de Simpson 3/8 aproxima la función \(f(x)\) usando un polinomio de tercer grado que pasa por cuatro puntos equiespaciados: \((x_0, f(x_0))\), \((x_1, f(x_1))\), \((x_2, f(x_2))\), y \((x_3, f(x_3))\).
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-1 font-medium">Fórmula Simple (tres segmentos, cuatro puntos):</p>
                        <p class="text-gray-600 leading-relaxed mb-3">El intervalo de integración es \([x_0, x_3]\). Sea \(h = (x_3-x_0)/3\).</p>
                        <p style="text-align:center;" class="my-2">\(I \approx \frac{3h}{8} [f(x_0) + 3f(x_1) + 3f(x_2) + f(x_3)]\)</p>
                        <p class="text-gray-600 leading-relaxed mb-3">El error de truncamiento local es de orden \(O(h^5)\).</p>
                        <p class="text-gray-600 leading-relaxed mb-1 font-medium">Fórmula Compuesta:</p>
                        <p class="text-gray-600 leading-relaxed mb-3">Requiere que el número de segmentos \(n\) sea un <strong>múltiplo de 3</strong>. Sea \(h = (b-a)/n\).</p>
                        <div style="display: block; max-width: 100%; overflow-x: auto; text-align:center;">
                            <p style="white-space: nowrap;" class="my-2">\(I \approx \frac{3h}{8} [f(x_0) + 3\sum_{i=1,4,7,...}^{n-2} (f(x_i) + f(x_{i+1})) + 2\sum_{i=3,6,9,...}^{n-3} f(x_i) + f(x_n)]\)</p>
                        </div>
                        <p class="text-gray-600 leading-relaxed mb-2">O, de forma más clara para la suma de los términos intermedios: la pauta de coeficientes es \(1, 3, 3, 2, 3, 3, 2, ..., 3, 3, 1\).</p>
                        <p class="text-gray-600 leading-relaxed mb-4">El error de truncamiento global es de orden \(O(h^4)\) (o \(O(1/n^4)\)).</p>
                    </section>

                    <section id="algoritmo" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Pasos del Algoritmo</h3>
                        <h4 class="text-lg font-semibold mt-4 mb-2 text-gray-700">Regla del Trapecio Compuesta</h4>
                        <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-600 leading-relaxed">
                            <li>Definir la función \(f(x)\), los límites de integración \(a\) y \(b\), y el número de segmentos \(n\).</li>
                            <li>Calcular el ancho del segmento: \(h = (b - a) / n\).</li>
                            <li>Inicializar la suma: \(S = f(a) + f(b)\).</li>
                            <li>Sumar los términos intermedios: Para \(i\) desde 1 hasta \(n-1\), calcular \(x_i = a + i \cdot h\) y añadir \(2 \cdot f(x_i)\) a \(S\).</li>
                            <li>Calcular la integral: \(I = (h/2) \cdot S\).</li>
                        </ol>

                        <h4 class="text-lg font-semibold mt-6 mb-2 text-gray-700">Regla de Simpson 1/3 Compuesta (n debe ser par)</h4>
                        <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-600 leading-relaxed">
                            <li>Definir \(f(x)\), \(a\), \(b\), y \(n\) (asegurar que \(n\) sea par).</li>
                            <li>Calcular \(h = (b - a) / n\).</li>
                            <li>Inicializar la suma: \(S = f(a) + f(b)\).</li>
                            <li>Sumar términos con coeficiente 4 (índices impares): Para \(i\) desde 1 hasta \(n-1\) con paso 2, calcular \(x_i = a + i \cdot h\) y añadir \(4 \cdot f(x_i)\) a \(S\).</li>
                            <li>Sumar términos con coeficiente 2 (índices pares): Para \(i\) desde 2 hasta \(n-2\) con paso 2, calcular \(x_i = a + i \cdot h\) y añadir \(2 \cdot f(x_i)\) a \(S\).</li>
                            <li>Calcular la integral: \(I = (h/3) \cdot S\).</li>
                        </ol>

                        <h4 class="text-lg font-semibold mt-6 mb-2 text-gray-700">Regla de Simpson 3/8 Compuesta (n debe ser múltiplo de 3)</h4>
                         <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-600 leading-relaxed">
                            <li>Definir \(f(x)\), \(a\), \(b\), y \(n\) (asegurar que \(n\) sea múltiplo de 3).</li>
                            <li>Calcular \(h = (b - a) / n\).</li>
                            <li>Inicializar la suma: \(S = f(a) + f(b)\).</li>
                            <li>Para \(i\) desde 1 hasta \(n-1\):
                                <ul class="list-disc list-inside space-y-1 pl-6 mt-1">
                                    <li>Si \(i \pmod 3 == 0\) (ej. 3, 6, 9,...), añadir \(2 \cdot f(a + i \cdot h)\) a \(S\).</li>
                                    <li>En caso contrario (ej. 1, 2, 4, 5,...), añadir \(3 \cdot f(a + i \cdot h)\) a \(S\).</li>
                                </ul>
                            </li>
                            <li>Calcular la integral: \(I = (3h/8) \cdot S\).</li>
                        </ol>
                    </section>

                    <section id="ejemplo" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Ejemplo Paso a Paso</h3>
                        <p class="text-gray-600 leading-relaxed mb-3">
                            Estimar la integral de \(f(x) = x^2\) desde \(a=0\) hasta \(b=2\). La integral exacta es \(\int_{0}^{2} x^2 dx = [x^3/3]_0^2 = 8/3 \approx 2.666667\).
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-3">
                            <strong>Usando \(n=4\) segmentos (\(h = (2-0)/4 = 0.5\)):</strong>
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-1">Puntos: \(x_0=0, x_1=0.5, x_2=1, x_3=1.5, x_4=2\)</p>
                        <p class="text-gray-600 leading-relaxed mb-4">Valores de \(f(x)\): \(f(0)=0, f(0.5)=0.25, f(1)=1, f(1.5)=2.25, f(2)=4\)</p>

                        <p class="font-medium text-gray-700 mb-1">1. Regla del Trapecio (\(n=4\)):</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-1">\(I \approx (0.5/2) \cdot [f(0) + 2f(0.5) + 2f(1) + 2f(1.5) + f(2)]\)</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-1">\(I \approx 0.25 \cdot [0 + 2(0.25) + 2(1) + 2(2.25) + 4]\)</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-4">\(I \approx 0.25 \cdot [0 + 0.5 + 2 + 4.5 + 4] = 0.25 \cdot 11 = 2.75\) (Error: \(|2.75 - 2.666667| \approx 0.083333\))</p>

                        <p class="font-medium text-gray-700 mb-1">2. Regla de Simpson 1/3 (\(n=4\), es par):</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-1">\(I \approx (0.5/3) \cdot [f(0) + 4f(0.5) + 2f(1) + 4f(1.5) + f(2)]\)</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-1">\(I \approx (0.5/3) \cdot [0 + 4(0.25) + 2(1) + 4(2.25) + 4]\)</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-4">\(I \approx (0.5/3) \cdot [0 + 1 + 2 + 9 + 4] = (0.5/3) \cdot 16 = 8/3 \approx 2.666667\) (Error: 0, exacto para polinomios de grado \(\le 3\))</p>

                        <p class="text-gray-600 leading-relaxed my-3">
                            <strong>Usando \(n=3\) segmentos (\(h = (2-0)/3 \approx 0.666667\)) para Simpson 3/8:</strong>
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-1">Puntos: \(x_0=0, x_1=2/3, x_2=4/3, x_3=2\)</p>
                        <p class="text-gray-600 leading-relaxed mb-1">Valores de \(f(x)\): \(f(0)=0, f(2/3)=4/9, f(4/3)=16/9, f(2)=4\)</p>
                        <p class="text-gray-600 leading-relaxed mb-4">\(h = 2/3\)</p>

                        <p class="font-medium text-gray-700 mb-1">3. Regla de Simpson 3/8 (\(n=3\), es múltiplo de 3):</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-1">\(I \approx (3 \cdot (2/3)/8) \cdot [f(0) + 3f(2/3) + 3f(4/3) + f(2)]\)</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-1">\(I \approx (2/8) \cdot [0 + 3(4/9) + 3(16/9) + 4]\)</p>
                        <p class="text-gray-600 leading-relaxed ml-4 mb-4">\(I \approx 0.25 \cdot [0 + 12/9 + 48/9 + 36/9] = 0.25 \cdot [96/9] = 0.25 \cdot (32/3) = 8/3 \approx 2.666667\) (Error: 0, exacto para polinomios de grado \(\le 3\))</p>
                    </section>

                    <section id="codigo" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Código de Implementación (Python) - Ejecutable</h3>
                        <div class="code-editor-container bg-gray-50 p-4 rounded-lg shadow-inner">
                            <textarea id="intnum-code-input" class="code-input w-full h-96 p-3 border border-gray-300 rounded-md font-mono text-sm" style="resize: none;">
import math

def func_to_integrate(x):
    # f(x) = x^3 - 2x + 5
    return x**3 - 2*x + 5

def exact_integral_val_func(x):
    # F(x) = (1/4)x^4 - x^2 + 5x  (Primitiva de func_to_integrate)
    return (1/4)*x**4 - x**2 + 5*x

def calculate_exact_integral(a, b):
    # Calcula la integral definida F(b) - F(a)
    return exact_integral_val_func(b) - exact_integral_val_func(a)

# Regla del Trapecio Compuesta
def trapezoidal_rule(f, a, b, n):
    h = (b - a) / n
    integral_sum = f(a) + f(b)
    points_x = [a + i * h for i in range(n + 1)]
    points_y = [f(x_val) for x_val in points_x]
    for i in range(1, n):
        integral_sum += 2 * points_y[i]
    integral = (h / 2) * integral_sum
    return integral, points_x, points_y

# Regla de Simpson 1/3 Compuesta
def simpson_one_third_rule(f, a, b, n):
    if n % 2 != 0:
        return "Error: n debe ser par", [], []
    h = (b - a) / n
    integral_sum = f(a) + f(b)
    points_x = [a + i * h for i in range(n + 1)]
    points_y = [f(x_val) for x_val in points_x]
    for i in range(1, n):
        if i % 2 == 1: # Impar
            integral_sum += 4 * points_y[i]
        else: # Par
            integral_sum += 2 * points_y[i]
    integral = (h / 3) * integral_sum
    return integral, points_x, points_y

# Regla de Simpson 3/8 Compuesta
def simpson_three_eighth_rule(f, a, b, n):
    if n % 3 != 0:
        return "Error: n debe ser múltiplo de 3", [], []
    h = (b - a) / n
    integral_sum = f(a) + f(b)
    points_x = [a + i * h for i in range(n + 1)]
    points_y = [f(x_val) for x_val in points_x]
    for i in range(1, n):
        if i % 3 == 0:
            integral_sum += 2 * points_y[i]
        else:
            integral_sum += 3 * points_y[i]
    integral = (3 * h / 8) * integral_sum
    return integral, points_x, points_y

# --- Parámetros Ejemplo ---
if __name__ == "__main__":
    output_buffer_intnum = []
    
    a_limit = 0.0
    b_limit = 2.0
    num_segments = 6 # Debe ser par para S1/3 y múltiplo de 3 para S3/8. 6 funciona.
    # num_segments = 4 # Para probar S1/3 con n no múltiplo de 3
    # num_segments = 3 # Para probar S3/8 con n no par

    nombre_func_str = 'f(x) = x³ - 2x + 5'
    exact_val = calculate_exact_integral(a_limit, b_limit) # Calculado dinámicamente

    initial_info_html_intnum = '<div style="text-align: center; font-weight: bold; margin-bottom:15px; font-size:1.1em;">MÉTODOS DE INTEGRACIÓN NUMÉRICA</div>'
    initial_info_html_intnum += f'<div style="text-align: center; margin-bottom:5px;">Función: {nombre_func_str}</div>'
    initial_info_html_intnum += f'<div style="text-align: center; margin-bottom:5px;">Intervalo de integración: [{a_limit}, {b_limit}]</div>'
    initial_info_html_intnum += f'<div style="text-align: center; margin-bottom:5px;">Número de segmentos (n): {num_segments}</div>'
    if exact_val is not None:
        initial_info_html_intnum += f'<div style="text-align: center; margin-bottom:15px;">Valor exacto de la integral: {exact_val:.7f}</div>'
    else: # Este caso no debería ocurrir con la nueva función
        initial_info_html_intnum += f'<div style="text-align: center; margin-bottom:15px;">Valor exacto no precalculado para esta función.</div>'

    output_buffer_intnum.append(initial_info_html_intnum)

    # Tabla de resultados
    html_table = '<table border="1" style="width:100%; border-collapse: collapse; margin-bottom:15px; font-size: 0.9em;">'
    html_table += '<thead><tr>'
    headers = ["Método", "Valor Calculado", "Error Absoluto", "Error Relativo (%)"]
    for h_col in headers:
        html_table += f'<th style="padding: 4px; text-align:center; background-color: #e9eff1; color: black;">{h_col}</th>'
    html_table += '</tr></thead><tbody>'

    graph_data_points = [] # Para la gráfica

    # Trapecio
    val_trap, px_trap, py_trap = trapezoidal_rule(func_to_integrate, a_limit, b_limit, num_segments)
    graph_data_points.append({'method': 'Trapecio', 'x_points': px_trap, 'y_points': py_trap, 'n_segments': num_segments})
    html_table += '<tr><td style="padding: 4px; text-align:left; padding-left:5px;">Regla del Trapecio</td>'
    html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{val_trap:.7f}</td>'
    if exact_val is not None:
        err_abs_trap = abs(val_trap - exact_val)
        err_rel_trap = (err_abs_trap / abs(exact_val) * 100) if exact_val != 0 else float('inf')
        html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{err_abs_trap:.2e}</td>'
        html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{err_rel_trap:.4f}%</td>'
    else:
        html_table += '<td style="padding: 4px; text-align:center;" colspan="2">-</td>'
    html_table += '</tr>'

    # Simpson 1/3
    val_s13, px_s13, py_s13 = simpson_one_third_rule(func_to_integrate, a_limit, b_limit, num_segments)
    if isinstance(val_s13, str): # Error
        html_table += f'<tr><td style="padding: 4px; text-align:left; padding-left:5px;">Regla de Simpson 1/3</td><td style="padding: 4px; text-align:center; color:red;" colspan="3">{val_s13} (n={num_segments})</td></tr>'
    else:
        graph_data_points.append({'method': 'Simpson 1/3', 'x_points': px_s13, 'y_points': py_s13, 'n_segments': num_segments})
        html_table += '<tr><td style="padding: 4px; text-align:left; padding-left:5px;">Regla de Simpson 1/3</td>'
        html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{val_s13:.7f}</td>'
        if exact_val is not None:
            err_abs_s13 = abs(val_s13 - exact_val)
            err_rel_s13 = (err_abs_s13 / abs(exact_val) * 100) if exact_val != 0 else float('inf')
            html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{err_abs_s13:.2e}</td>'
            html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{err_rel_s13:.4f}%</td>'
        else:
            html_table += '<td style="padding: 4px; text-align:center;" colspan="2">-</td>'
        html_table += '</tr>'

    # Simpson 3/8
    val_s38, px_s38, py_s38 = simpson_three_eighth_rule(func_to_integrate, a_limit, b_limit, num_segments)
    if isinstance(val_s38, str): # Error
        html_table += f'<tr><td style="padding: 4px; text-align:left; padding-left:5px;">Regla de Simpson 3/8</td><td style="padding: 4px; text-align:center; color:red;" colspan="3">{val_s38} (n={num_segments})</td></tr>'
    else:
        graph_data_points.append({'method': 'Simpson 3/8', 'x_points': px_s38, 'y_points': py_s38, 'n_segments': num_segments})
        html_table += '<tr><td style="padding: 4px; text-align:left; padding-left:5px;">Regla de Simpson 3/8</td>'
        html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{val_s38:.7f}</td>'
        if exact_val is not None:
            err_abs_s38 = abs(val_s38 - exact_val)
            err_rel_s38 = (err_abs_s38 / abs(exact_val) * 100) if exact_val != 0 else float('inf')
            html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{err_abs_s38:.2e}</td>'
            html_table += f'<td style="padding: 4px; text-align:right; padding-right:5px;">{err_rel_s38:.4f}%</td>'
        else:
            html_table += '<td style="padding: 4px; text-align:center;" colspan="2">-</td>'
        html_table += '</tr>'
        
    html_table += '</tbody></table>'
    output_buffer_intnum.append(html_table)

    # Para Pyodide
    try:
        global js_iteration_data_intnum 
        js_data_container_intnum = js_iteration_data_intnum
        js_data_container_intnum.clear()
        
        plot_x_min = a_limit - 0.1 * (b_limit - a_limit)
        plot_x_max = b_limit + 0.1 * (b_limit - a_limit)
        if plot_x_min == plot_x_max: # Avoid division by zero if a=b
             plot_x_min -= 0.5
             plot_x_max += 0.5

        fine_x_vals = [plot_x_min + i * (plot_x_max - plot_x_min) / 199 for i in range(200)]
        fine_y_vals = [func_to_integrate(x) for x in fine_x_vals]

        js_data_container_intnum.append({
            'type': 'function_plot',
            'x_values': fine_x_vals,
            'y_values': fine_y_vals
        })
        js_data_container_intnum.append({
            'type': 'integration_params',
            'a': a_limit,
            'b': b_limit,
            'n': num_segments,
            'points_data': graph_data_points
        })
        
        global pyodide_html_output
        pyodide_html_output = "\\n".join(output_buffer_intnum)
    except NameError:
        print("Ejecutando localmente (Integración Numérica), imprimiendo HTML generado:")
        print("\\n".join(output_buffer_intnum))
                            </textarea>
                            <button id="run-intnum-code-button" class="run-button mt-4 px-5 py-2.5 bg-custom-red text-white rounded-md hover:bg-red-700">Ejecutar Código</button>

                            <div class="relative">
                                <div id="intnum-output-controls-container" class="absolute top-0 right-0 z-10 flex items-center space-x-1 transition-all duration-500 ease-out">
                                    <button id="intnum-decrease-font-button" title="Disminuir fuente" class="p-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 text-xs font-semibold flex items-center justify-center" style="min-width: 30px; display: none;">
                                        aa
                                    </button>
                                    <button id="intnum-increase-font-button" title="Aumentar fuente" class="p-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 text-xs font-semibold flex items-center justify-center" style="min-width: 30px; display: none;">
                                        AA
                                    </button>
                                    <button id="intnum-fullscreen-output-button" title="Ver en pantalla completa" class="p-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 text-xs">
                                        <!-- SVG will be injected by JS -->
                                    </button>
                                </div>
                                <h4 class="mt-5 mb-2 text-lg font-semibold text-gray-700">Salida:</h4>
                                <pre id="intnum-code-output" class="code-output bg-gray-900 text-white p-4 pt-10 rounded-md min-h-[100px] whitespace-pre-wrap transition-all duration-500 ease-out text-xs leading-relaxed max-h-96 overflow-y-auto font-mono">Presiona "Ejecutar Código" para ver la salida.</pre>
                            </div>
                        </div>
                    </section>

                    <section id="graficas" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Gráficas Interactivas</h3>
                        <p class="text-gray-600 leading-relaxed mb-4">La gráfica mostrará la función \(f(x)\) que se está integrando, junto con los puntos \( (x_i, f(x_i)) \) utilizados por los métodos numéricos. Se destacará el área bajo la curva en el intervalo \([a, b]\).</p>
                        <div class="interactive-graphics w-full h-96 bg-white p-4 rounded-lg shadow-md">
                            <canvas id="intnum-chart"></canvas>
                            <p id="chart-loading-message-intnum" class="text-center text-gray-600 italic mt-2">Ejecute el código para generar los datos de la gráfica.</p>
                        </div>
                    </section>

                    <section id="videos" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Videos Explicativos</h3>
                        <div class="grid grid-cols-1 gap-6">
                            <div class="video-embed w-full h-72">
                                <iframe class="w-full h-full rounded-lg shadow-lg" src="https://www.youtube.com/embed/XMjlr_7IUl0" title="YouTube video player - Regla del Trapecio" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                                <p class="text-center text-sm text-gray-500 mt-1">Regla del Trapecio</p>
                            </div>
                            <div class="video-embed w-full h-72">
                                <iframe class="w-full h-full rounded-lg shadow-lg" src="https://www.youtube.com/embed/IGC_tEOsdQ8" title="YouTube video player - Reglas de Simpson" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                                <p class="text-center text-sm text-gray-500 mt-1">Reglas de Simpson</p>
                            </div>
                        </div>
                    </section>

                    <section id="conclusion-metodo" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Conclusión y Aplicaciones</h3>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            Las reglas del Trapecio y de Simpson (1/3 y 3/8) son métodos fundamentales para la integración numérica. La elección entre ellas depende de la precisión deseada, las características de la función y el número de puntos disponibles.
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            La Regla del Trapecio es la más simple pero generalmente la menos precisa. La Regla de Simpson 1/3 ofrece mayor precisión (error \(O(h^4)\)) y es muy popular, pero requiere un número par de segmentos. La Regla de Simpson 3/8 también tiene un error \(O(h^4)\) y puede ser útil si el número de segmentos es múltiplo de 3, o para combinar con la regla 1/3 si hay un número impar de segmentos total.
                        </p>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            Para mayor precisión, se pueden usar más segmentos (\(h\) más pequeño) o métodos de orden superior (como la cuadratura de Gauss), aunque estos últimos son más complejos.
                        </p>
                         <p class="text-gray-600 leading-relaxed mb-2 font-medium">
                            <strong>Aplicaciones:</strong>
                        </p>
                        <ul class="list-disc list-inside space-y-2 pl-4 text-gray-600 mb-4">
                            <li>Cálculo de áreas, volúmenes, longitudes de arco.</li>
                            <li>Resolución de ecuaciones diferenciales.</li>
                            <li>Análisis de datos experimentales donde la función no se conoce analíticamente.</li>
                            <li>En física e ingeniería para calcular cantidades como trabajo, flujo, centro de masa, etc.</li>
                            <li>Probabilidad y estadística (ej. cálculo de funciones de distribución acumulada).</li>
                        </ul>
                    </section>

                    <section id="referencias" class="mb-10 scroll-mt-24">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Referencias</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-600 leading-relaxed pl-4">
                            <li>Chapra, S. C., & Canale, R. P. (2015). <em>Numerical Methods for Engineers</em> (7th ed.). McGraw-Hill Education. (Principalmente Capítulos 21 y 22 para Integración Numérica).</li>
                        </ul>
                    </section>

                    <section id="cuestionario" class="scroll-mt-24 mb-10">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-700">Cuestionario: Integración Numérica</h3>
                        <form id="quiz-integracion-numerica" class="space-y-6 bg-gray-50 p-6 rounded-lg shadow-inner">
                            <!-- Pregunta 1 -->
                            <div class="quiz-question space-y-2">
                                <p class="text-sm font-medium text-gray-700">1. La Regla de Simpson 1/3 aproxima la función \(f(x)\) en cada par de segmentos usando un:</p>
                                <fieldset class="mt-2">
                                    <legend class="sr-only">Opciones para la pregunta 1</legend>
                                    <div class="space-y-2">
                                        <label for="q1-opt1-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q1-opt1-intnum" name="question-1-integracion-numerica" type="radio" value="Polinomio lineal (línea recta)." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Polinomio lineal (línea recta).</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q1-opt2-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q1-opt2-intnum" name="question-1-integracion-numerica" type="radio" value="Polinomio cuadrático (parábola)." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Polinomio cuadrático (parábola).</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q1-opt3-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q1-opt3-intnum" name="question-1-integracion-numerica" type="radio" value="Polinomio cúbico." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Polinomio cúbico.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                    </div>
                                </fieldset>
                                <div id="question-1-integracion-numerica-specific-feedback" class="specific-question-feedback mt-2 p-2.5 text-xs bg-red-50 text-red-600 border border-red-200 rounded-md" style="display: none;"></div>
                            </div>

                            <!-- Pregunta 2 -->
                            <div class="quiz-question space-y-2">
                                <p class="text-sm font-medium text-gray-700">2. Para aplicar la Regla de Simpson 1/3 compuesta, el número de segmentos \(n\) debe ser:</p>
                                <fieldset class="mt-2">
                                    <legend class="sr-only">Opciones para la pregunta 2</legend>
                                    <div class="space-y-2">
                                        <label for="q2-opt1-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q2-opt1-intnum" name="question-2-integracion-numerica" type="radio" value="Impar." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Impar.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q2-opt2-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q2-opt2-intnum" name="question-2-integracion-numerica" type="radio" value="Par." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Par.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q2-opt3-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q2-opt3-intnum" name="question-2-integracion-numerica" type="radio" value="Múltiplo de 3." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Múltiplo de 3.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                    </div>
                                </fieldset>
                                <div id="question-2-integracion-numerica-specific-feedback" class="specific-question-feedback mt-2 p-2.5 text-xs bg-red-50 text-red-600 border border-red-200 rounded-md" style="display: none;"></div>
                            </div>

                            <!-- Pregunta 3 -->
                            <div class="quiz-question space-y-2">
                                <p class="text-sm font-medium text-gray-700">3. ¿Cuál de estas reglas de integración numérica compuesta tiene generalmente un orden de error global más favorable (converge más rápido con \(n\))?</p>
                                <fieldset class="mt-2">
                                    <legend class="sr-only">Opciones para la pregunta 3</legend>
                                    <div class="space-y-2">
                                        <label for="q3-opt1-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q3-opt1-intnum" name="question-3-integracion-numerica" type="radio" value="Regla del Trapecio." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Regla del Trapecio.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q3-opt2-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q3-opt2-intnum" name="question-3-integracion-numerica" type="radio" value="Regla de Simpson 1/3." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Regla de Simpson 1/3.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q3-opt3-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q3-opt3-intnum" name="question-3-integracion-numerica" type="radio" value="Ambas reglas de Simpson tienen el mismo orden de error global." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Ambas reglas de Simpson tienen el mismo orden de error global.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                    </div>
                                </fieldset>
                                <div id="question-3-integracion-numerica-specific-feedback" class="specific-question-feedback mt-2 p-2.5 text-xs bg-red-50 text-red-600 border border-red-200 rounded-md" style="display: none;"></div>
                            </div>
                            
                            <!-- Pregunta 4 -->
                            <div class="quiz-question space-y-2">
                                <p class="text-sm font-medium text-gray-700">4. La Regla de Simpson 3/8 utiliza una aproximación polinómica de grado... para cada conjunto de tres segmentos.</p>
                                <fieldset class="mt-2">
                                    <legend class="sr-only">Opciones para la pregunta 4</legend>
                                    <div class="space-y-2">
                                        <label for="q4-opt1-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q4-opt1-intnum" name="question-4-integracion-numerica" type="radio" value="Dos." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Dos.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q4-opt2-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q4-opt2-intnum" name="question-4-integracion-numerica" type="radio" value="Tres." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Tres.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                        <label for="q4-opt3-intnum" class="quiz-option-wrapper flex items-center p-3 w-full rounded-md border border-gray-300 hover:border-gray-400 cursor-pointer transition-all duration-150 has-[:checked]:bg-red-50 has-[:checked]:border-custom-red has-[:checked]:ring-1 has-[:checked]:ring-custom-red">
                                            <input id="q4-opt3-intnum" name="question-4-integracion-numerica" type="radio" value="Cuatro." class="h-4 w-4 text-custom-red border-gray-300 focus:ring-custom-red accent-custom-red">
                                            <span class="option-text ml-3 text-sm text-gray-700">Cuatro.</span>
                                            <span class="feedback-icon-placeholder ml-auto pl-2"><span class="inline-block w-5 h-5"></span></span>
                                        </label>
                                    </div>
                                </fieldset>
                                <div id="question-4-integracion-numerica-specific-feedback" class="specific-question-feedback mt-2 p-2.5 text-xs bg-red-50 text-red-600 border border-red-200 rounded-md" style="display: none;"></div>
                            </div>

                            <button type="submit" class="mt-6 w-full px-6 py-3 bg-custom-red text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-150">
                                Enviar Respuestas
                            </button>
                        </form>
                        <div id="quiz-feedback-integracion-numerica" class="quiz-feedback-message mt-4 p-3 rounded-md text-sm" style="display: none;"></div>
                    </section>
                </article>
            </main>

            <aside class="w-full lg:w-1/4 bg-sidebar-bg shadow-xl rounded-lg p-6 self-start sticky top-8 order-3 space-y-6">
                <div class="pb-6 border-b border-gray-200">
                    <h3 class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">Perfil</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                           <svg class="w-12 h-12 text-gray-400 bg-gray-100 rounded-full p-1 ring-1 ring-gray-200" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800 text-md">Estudiante Modelo</p>
                            <p class="text-sm text-gray-500">Aprendiz Activo</p>
                        </div>
                    </div>
                </div>

                <div class="pb-6 border-b border-gray-200 space-y-3">
                    <h3 class="text-base font-semibold text-gray-500 uppercase tracking-wide">Progreso en Integración Numérica</h3>
                    
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center">
                            <span id="task-read-theory-status-intnum" class="task-status-icon mr-2 text-gray-400">
                                <!-- Icono se inserta por JS -->
                            </span>
                            <span class="text-gray-600">Leer la teoría completa</span>
                        </li>
                        <li class="flex items-center">
                            <span id="task-run-code-status-intnum" class="task-status-icon mr-2 text-gray-400">
                                <!-- Icono se inserta por JS -->
                            </span>
                            <span class="text-gray-600">Ejecutar el código Python</span>
                        </li>
                        <li class="flex items-center">
                            <span id="task-quiz-attempted-status-intnum" class="task-status-icon mr-2 text-gray-400">
                                <!-- Icono se inserta por JS -->
                            </span>
                            <span class="text-gray-600">Intentar el cuestionario</span>
                        </li>
                        <li class="flex items-center">
                            <span id="task-quiz-passed-status-intnum" class="task-status-icon mr-2 text-gray-400">
                                <!-- Icono se inserta por JS -->
                            </span>
                            <span class="text-gray-600">Aprobar el cuestionario</span>
                        </li>
                    </ul>

                    <div class="flex items-center justify-between mb-1 mt-3">
                       <span class="text-xs font-medium text-custom-red">Progreso General</span>
                       <span id="right-sidebar-progress-text-intnum" class="text-xs font-medium text-custom-red right-sidebar-progress-text">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="right-sidebar-progress-bar-intnum" class="bg-custom-red h-3 rounded-full right-sidebar-progress-bar transition-width duration-500 ease-in-out" style="width: 0%"></div>
                    </div>
                    
                    <button id="completion-integracion-numerica-sidebar" class="mt-4 w-full completion-button px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 font-medium text-sm transition-colors duration-150">Marcar Todo Completado</button>
                </div>

                <div class="pb-6 border-b border-gray-200">
                    <h3 class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-3">Recursos y Notas</h3>
                    <p class="text-sm text-gray-600">
                        <a href="https://archive.org/details/numerical-methods-for-engineers-7th-edit" target="_blank" rel="noopener noreferrer" class="hover:text-custom-red hover:underline">
                            Métodos Numéricos para Ingenieros 7ma Edición de Chapra
                        </a>
                    </p>
                    <img src="https://images.cdn3.buscalibre.com/fit-in/360x360/97/ff/97ffa61a8adb147e569e12c4f1f797b3.jpg" alt="Portada del libro Métodos Numéricos para Ingenieros de Chapra" class="mt-2 w-full rounded-md shadow-sm">
                </div>

                <div>
                    <h3 class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-3">Siguiente Paso</h3>
                    <a href="../index.html" class="group flex items-center text-sm font-medium text-custom-red hover:text-red-700 transition-colors duration-150">
                       <span>Volver a la lista de métodos</span> 
                       <svg class="w-4 h-4 ml-1 transform group-hover:translate-x-1 transition-transform duration-150" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                    </a>
                </div>
            </aside>

        </div>

        <footer class="bg-custom-blue text-gray-300 text-center p-6 mt-12">
            <p>&copy; 2024 Plataforma Educativa de Métodos Numéricos. <a href="../index.html" class="hover:text-white underline">Volver al inicio</a></p>
        </footer>
    </div>

    <!-- START INTNUM SCRIPT -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- START: Fullscreen and Font Control Logic for Code Output ---
        const fullscreenButton_INTNUM = document.getElementById('intnum-fullscreen-output-button');
        const codeOutput_INTNUM = document.getElementById('intnum-code-output');
        const outputControlsContainer_INTNUM = document.getElementById('intnum-output-controls-container');

        const increaseFontButton_INTNUM = document.getElementById('intnum-increase-font-button');
        const decreaseFontButton_INTNUM = document.getElementById('intnum-decrease-font-button');
        let originalOutputFontSize_INTNUM = '';
        const MIN_FONT_SIZE_PX_INTNUM = 8;
        const MAX_FONT_SIZE_PX_INTNUM = 28;
        const FONT_SIZE_STEP_PX_INTNUM = 1;
        let intnumCodeOutputInitialRect = null;

        if (fullscreenButton_INTNUM) {
            fullscreenButton_INTNUM.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9m5.25 11.25v-4.5m0 4.5h-4.5m4.5 0L15 15" />
                </svg>`;
            fullscreenButton_INTNUM.title = "Ver en pantalla completa";
        }

        if (fullscreenButton_INTNUM && codeOutput_INTNUM && outputControlsContainer_INTNUM) {
            fullscreenButton_INTNUM.addEventListener('click', () => {
                const isFullscreen = codeOutput_INTNUM.classList.contains('intnum-output-fullscreen');
                if (isFullscreen) {
                    outputControlsContainer_INTNUM.style.opacity = '0';
                    if(increaseFontButton_INTNUM) increaseFontButton_INTNUM.style.display = 'none';
                    if(decreaseFontButton_INTNUM) decreaseFontButton_INTNUM.style.display = 'none';

                    if (intnumCodeOutputInitialRect) {
                        const finalRect = codeOutput_INTNUM.getBoundingClientRect();
                        const scaleX = intnumCodeOutputInitialRect.width / finalRect.width;
                        const scaleY = intnumCodeOutputInitialRect.height / finalRect.height;
                        const deltaX = (intnumCodeOutputInitialRect.left + intnumCodeOutputInitialRect.width / 2) - (finalRect.left + finalRect.width / 2);
                        const deltaY = (intnumCodeOutputInitialRect.top + intnumCodeOutputInitialRect.height / 2) - (finalRect.top + finalRect.height / 2);
                        codeOutput_INTNUM.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
                    }
                    setTimeout(() => {
                        codeOutput_INTNUM.style.transition = 'none';
                        codeOutput_INTNUM.classList.remove('intnum-output-fullscreen');
                        document.body.classList.remove('intnum-body-fullscreen-active');
                        outputControlsContainer_INTNUM.classList.remove('intnum-output-controls-container-fixed');
                        outputControlsContainer_INTNUM.style.transition = 'none';
                        outputControlsContainer_INTNUM.style.opacity = '1';
                        outputControlsContainer_INTNUM.offsetHeight;
                        outputControlsContainer_INTNUM.style.transition = '';
                        codeOutput_INTNUM.style.transform = '';
                        if (originalOutputFontSize_INTNUM) codeOutput_INTNUM.style.fontSize = originalOutputFontSize_INTNUM;
                        codeOutput_INTNUM.offsetHeight;
                        codeOutput_INTNUM.style.transition = '';
                        fullscreenButton_INTNUM.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9m5.25 11.25v-4.5m0 4.5h-4.5m4.5 0L15 15" /></svg>`;
                        fullscreenButton_INTNUM.title = "Ver en pantalla completa";
                        intnumCodeOutputInitialRect = null;
                    }, 500);
                } else {
                    originalOutputFontSize_INTNUM = window.getComputedStyle(codeOutput_INTNUM).fontSize;
                    intnumCodeOutputInitialRect = codeOutput_INTNUM.getBoundingClientRect();
                    outputControlsContainer_INTNUM.style.transition = 'none';
                    outputControlsContainer_INTNUM.style.opacity = '0';
                    outputControlsContainer_INTNUM.offsetHeight;
                    outputControlsContainer_INTNUM.style.transition = '';
                    if(increaseFontButton_INTNUM) increaseFontButton_INTNUM.style.display = 'none';
                    if(decreaseFontButton_INTNUM) decreaseFontButton_INTNUM.style.display = 'none';
                    codeOutput_INTNUM.style.transition = 'none';
                    codeOutput_INTNUM.classList.add('intnum-output-fullscreen');
                    document.body.classList.add('intnum-body-fullscreen-active');
                    outputControlsContainer_INTNUM.classList.add('intnum-output-controls-container-fixed');
                    const finalRect = codeOutput_INTNUM.getBoundingClientRect();
                    const scaleX = intnumCodeOutputInitialRect.width / finalRect.width;
                    const scaleY = intnumCodeOutputInitialRect.height / finalRect.height;
                    const deltaX = (intnumCodeOutputInitialRect.left + intnumCodeOutputInitialRect.width / 2) - (finalRect.left + finalRect.width / 2);
                    const deltaY = (intnumCodeOutputInitialRect.top + intnumCodeOutputInitialRect.height / 2) - (finalRect.top + finalRect.height / 2);
                    codeOutput_INTNUM.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
                    codeOutput_INTNUM.offsetHeight;
                    codeOutput_INTNUM.style.transition = '';
                    codeOutput_INTNUM.style.transform = 'translate(0px, 0px) scale(1)';
                    fullscreenButton_INTNUM.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9V4.5M15 9h4.5M15 9l5.25-5.25M15 15v4.5M15 15h4.5M15 15l5.25 5.25" /></svg>`;
                    fullscreenButton_INTNUM.title = "Salir de pantalla completa";
                    setTimeout(() => {
                        outputControlsContainer_INTNUM.style.opacity = '1';
                        if(increaseFontButton_INTNUM) increaseFontButton_INTNUM.style.display = 'flex';
                        if(decreaseFontButton_INTNUM) decreaseFontButton_INTNUM.style.display = 'flex';
                    }, 500);
                }
            });
        }
        if (increaseFontButton_INTNUM && codeOutput_INTNUM) {
            increaseFontButton_INTNUM.addEventListener('click', (e) => {
                e.stopPropagation();
                const currentSize = parseFloat(window.getComputedStyle(codeOutput_INTNUM).fontSize);
                if (currentSize < MAX_FONT_SIZE_PX_INTNUM) {
                    codeOutput_INTNUM.style.fontSize = `${Math.min(currentSize + FONT_SIZE_STEP_PX_INTNUM, MAX_FONT_SIZE_PX_INTNUM)}px`;
                }
                increaseFontButton_INTNUM.classList.add('intnum-font-button-flash-blue');
                setTimeout(() => increaseFontButton_INTNUM.classList.remove('intnum-font-button-flash-blue'), 400);
            });
        }
        if (decreaseFontButton_INTNUM && codeOutput_INTNUM) {
            decreaseFontButton_INTNUM.addEventListener('click', (e) => {
                e.stopPropagation();
                const currentSize = parseFloat(window.getComputedStyle(codeOutput_INTNUM).fontSize);
                if (currentSize > MIN_FONT_SIZE_PX_INTNUM) {
                    codeOutput_INTNUM.style.fontSize = `${Math.max(currentSize - FONT_SIZE_STEP_PX_INTNUM, MIN_FONT_SIZE_PX_INTNUM)}px`;
                }
                decreaseFontButton_INTNUM.classList.add('intnum-font-button-flash-red');
                setTimeout(() => decreaseFontButton_INTNUM.classList.remove('intnum-font-button-flash-red'), 400);
            });
        }
        // --- END: Fullscreen and Font Control Logic ---

        const PAGE_KEY_INTNUM = 'integracion-numerica';
        const QUIZ_FORM_ID_INTNUM = 'quiz-integracion-numerica';
        const QUIZ_FEEDBACK_ID_INTNUM = 'quiz-feedback-integracion-numerica';
        const COMPLETION_BUTTON_ID_INTNUM = 'completion-integracion-numerica-sidebar';
        const CODE_INPUT_ID_INTNUM = 'intnum-code-input';
        const CODE_OUTPUT_ID_INTNUM = 'intnum-code-output';
        const RUN_CODE_BUTTON_ID_INTNUM = 'run-intnum-code-button';
        const CHART_CANVAS_ID_INTNUM = 'intnum-chart';
        const CHART_LOADING_MESSAGE_ID_INTNUM = 'chart-loading-message-intnum';

        const TASKS_INTNUM = {
            READ_THEORY: 'read_theory',
            RUN_CODE: 'run_code',
            QUIZ_ATTEMPTED: 'quiz_attempted',
            QUIZ_PASSED: 'quiz_passed'
        };
        const ALL_TASK_KEYS_INTNUM = Object.values(TASKS_INTNUM);
        const TOTAL_TASKS_INTNUM = ALL_TASK_KEYS_INTNUM.length;

        const ICON_PENDING_INTNUM = '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0-4.418-4.03-8-9-8S3 7.582 3 12c0 1.454.402 2.813 1.098 3.977L3 21l5.023-1.098A8.902 8.902 0 0012 21c4.97 0 9-3.582 9-9z"></path></svg>';
        const ICON_COMPLETED_INTNUM = '<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
        const ICON_IN_PROGRESS_INTNUM = '<svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V9.05a.75.75 0 011.307-.588l5.603 3.112z" clip-rule="evenodd"></path></svg>';
        const ICON_CORRECT_ANSWER_INTNUM = '✔️';
        const ICON_INCORRECT_ANSWER_INTNUM = '❌';
        const ICON_THUMB_UP_INTNUM = '👍';

        const quizDataIntegracionNumerica = {
            "question-1-integracion-numerica": {
                correctAnswer: "Polinomio cuadrático (parábola).",
                feedback: {
                    "Polinomio lineal (línea recta).": "Eso corresponde a la Regla del Trapecio.",
                    "Polinomio cúbico.": "Eso corresponde a la Regla de Simpson 3/8."
                }
            },
            "question-2-integracion-numerica": {
                correctAnswer: "Par.",
                feedback: {
                    "Impar.": "Incorrecto. Se necesitan 3 puntos (2 segmentos) para cada parábola.",
                    "Múltiplo de 3.": "Eso es para la Regla de Simpson 3/8."
                }
            },
            "question-3-integracion-numerica": {
                correctAnswer: "Ambas reglas de Simpson tienen el mismo orden de error global.",
                feedback: { //Chapra p. 600, 605. Both O(h^4)
                    "Regla del Trapecio.": "La Regla del Trapecio tiene un error global de O(h^2), que es menos favorable.",
                    "Regla de Simpson 1/3.": "Si bien es buena (O(h^4)), la Regla de Simpson 3/8 también tiene un error global O(h^4).",
                }
            },
            "question-4-integracion-numerica": {
                correctAnswer: "Tres.",
                feedback: {
                    "Dos.": "Un polinomio de grado dos (parábola) es usado por la Regla de Simpson 1/3.",
                    "Cuatro.": "Un polinomio de grado cuatro correspondería a una regla de Newton-Cotes de orden superior (Boole)."
                }
            }
        };

        let pyodide_INTNUM = null;
        let methodChart_INTNUM = null;
        const mainCompletionButton_INTNUM = document.getElementById(COMPLETION_BUTTON_ID_INTNUM);
        const quizForm_INTNUM = document.getElementById(QUIZ_FORM_ID_INTNUM);
        const generalQuizFeedbackDiv_INTNUM = document.getElementById(QUIZ_FEEDBACK_ID_INTNUM);
        const codeInput_INTNUM = document.getElementById(CODE_INPUT_ID_INTNUM);
        const runCodeButton_INTNUM = document.getElementById(RUN_CODE_BUTTON_ID_INTNUM);
        const chartCanvas_INTNUM = document.getElementById(CHART_CANVAS_ID_INTNUM);
        const chartLoadingMessage_INTNUM = document.getElementById(CHART_LOADING_MESSAGE_ID_INTNUM);

        const taskStatusIcons_INTNUM = {
            [TASKS_INTNUM.READ_THEORY]: document.getElementById('task-read-theory-status-intnum'),
            [TASKS_INTNUM.RUN_CODE]: document.getElementById('task-run-code-status-intnum'),
            [TASKS_INTNUM.QUIZ_ATTEMPTED]: document.getElementById('task-quiz-attempted-status-intnum'),
            [TASKS_INTNUM.QUIZ_PASSED]: document.getElementById('task-quiz-passed-status-intnum'),
        };
        const overallProgressText_INTNUM = document.getElementById('right-sidebar-progress-text-intnum');
        const overallProgressBar_INTNUM = document.getElementById('right-sidebar-progress-bar-intnum');

        function getPageProgressFromStorage_INTNUM(pKey) {
            const defaults = {
                [TASKS_INTNUM.READ_THEORY]: false, [TASKS_INTNUM.RUN_CODE]: false,
                [TASKS_INTNUM.QUIZ_ATTEMPTED]: false, [TASKS_INTNUM.QUIZ_PASSED]: false,
                overall_progress: 0, user_quiz_answers: {}, quiz_current_score: 0, quiz_feedback_active: false
            };
            try {
                const stored = localStorage.getItem(pKey);
                return stored ? { ...defaults, ...JSON.parse(stored) } : { ...defaults };
            } catch (e) { console.error("Error al leer el progreso del localStorage:", e); return { ...defaults }; }
        }

        function savePageProgressToStorage_INTNUM(pKey, progress) {
            try { localStorage.setItem(pKey, JSON.stringify(progress)); } 
            catch (e) { console.error("Error al guardar progreso en localStorage:", e); }
        }

        function updateTaskStatusInStorage_INTNUM(taskName, isCompleted) {
            let currentProgress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
            if (currentProgress[taskName] !== isCompleted) {
                currentProgress[taskName] = isCompleted;
                if (taskName === TASKS_INTNUM.QUIZ_ATTEMPTED && !isCompleted) {
                    currentProgress[TASKS_INTNUM.QUIZ_PASSED] = false;
                    currentProgress.user_quiz_answers = {}; currentProgress.quiz_current_score = 0; currentProgress.quiz_feedback_active = false;
                }
                if (taskName === TASKS_INTNUM.QUIZ_PASSED && !isCompleted && currentProgress[TASKS_INTNUM.QUIZ_ATTEMPTED]) { /* Keep answers */ }
                else if (taskName === TASKS_INTNUM.QUIZ_PASSED && !isCompleted) { currentProgress.user_quiz_answers = {}; currentProgress.quiz_current_score = 0; }
                savePageProgressToStorage_INTNUM(PAGE_KEY_INTNUM, currentProgress);
                calculateAndUpdateOverallProgress_INTNUM();
            }
        }

        function renderTaskStatus_INTNUM() {
            const progress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
            ALL_TASK_KEYS_INTNUM.forEach(taskKey => {
                const iconElement = taskStatusIcons_INTNUM[taskKey];
                if (iconElement) {
                    let newIconHTML = ICON_PENDING_INTNUM;
                    if (progress[taskKey]) newIconHTML = ICON_COMPLETED_INTNUM;
                    else if (taskKey === TASKS_INTNUM.QUIZ_PASSED && progress[TASKS_INTNUM.QUIZ_ATTEMPTED]) newIconHTML = ICON_IN_PROGRESS_INTNUM;
                    iconElement.innerHTML = newIconHTML;
                }
            });
        }

        function calculateAndUpdateOverallProgress_INTNUM() {
            let progress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
            let completedTasks = ALL_TASK_KEYS_INTNUM.filter(taskKey => progress[taskKey] === true).length;
            const percentage = TOTAL_TASKS_INTNUM > 0 ? (completedTasks / TOTAL_TASKS_INTNUM) * 100 : 0;
            progress.overall_progress = percentage;
            savePageProgressToStorage_INTNUM(PAGE_KEY_INTNUM, progress);

            const isHundredPercent = percentage.toFixed(0) === '100';
            if (overallProgressBar_INTNUM) {
                overallProgressBar_INTNUM.style.width = `${percentage.toFixed(0)}%`;
                if (isHundredPercent) overallProgressBar_INTNUM.classList.add('animate-rainbow-border');
                else overallProgressBar_INTNUM.classList.remove('animate-rainbow-border');
            }
            if (overallProgressText_INTNUM) overallProgressText_INTNUM.textContent = `${percentage.toFixed(0)}%`;
            renderTaskStatus_INTNUM();
            updateMainCompletionButtonState_INTNUM();
        }
        
        function handleMarkAllMouseEnter_INTNUM() {
            if (mainCompletionButton_INTNUM && mainCompletionButton_INTNUM.dataset.isUndo === "true") {
                mainCompletionButton_INTNUM.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                mainCompletionButton_INTNUM.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        function handleMarkAllMouseLeave_INTNUM() {
            if (mainCompletionButton_INTNUM && mainCompletionButton_INTNUM.dataset.isUndo === "true") {
                mainCompletionButton_INTNUM.classList.remove('bg-red-600', 'hover:bg-red-700');
                mainCompletionButton_INTNUM.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            }
        }

        function updateMainCompletionButtonState_INTNUM() {
            if (!mainCompletionButton_INTNUM) return;
            const progress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
            let allTasksCompleted = ALL_TASK_KEYS_INTNUM.every(task => progress[task] === true);
            
            mainCompletionButton_INTNUM.removeEventListener('mouseenter', handleMarkAllMouseEnter_INTNUM);
            mainCompletionButton_INTNUM.removeEventListener('mouseleave', handleMarkAllMouseLeave_INTNUM);
            mainCompletionButton_INTNUM.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-yellow-500', 'hover:bg-yellow-600', 'bg-red-600', 'hover:bg-red-700', 'opacity-50', 'cursor-not-allowed');
            mainCompletionButton_INTNUM.disabled = false;

            if (allTasksCompleted) {
                mainCompletionButton_INTNUM.textContent = 'Deshacer Completado';
                mainCompletionButton_INTNUM.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                mainCompletionButton_INTNUM.dataset.isUndo = "true";
                mainCompletionButton_INTNUM.addEventListener('mouseenter', handleMarkAllMouseEnter_INTNUM);
                mainCompletionButton_INTNUM.addEventListener('mouseleave', handleMarkAllMouseLeave_INTNUM);
            } else {
                mainCompletionButton_INTNUM.textContent = 'Marcar Todo Completado';
                mainCompletionButton_INTNUM.classList.add('bg-green-600', 'hover:bg-green-700');
                mainCompletionButton_INTNUM.dataset.isUndo = "false";
            }
        }

        function clearAllVisualFeedback_INTNUM(clearGeneralMessage = false) {
            if (!quizForm_INTNUM) return;
            quizForm_INTNUM.querySelectorAll('.quiz-option-wrapper').forEach(wrapper => {
                wrapper.classList.remove('correct-answer-intnum', 'incorrect-answer-intnum', 'border-green-500', 'border-red-500', 'ring-1', 'ring-green-500', 'ring-red-500', 'bg-green-50', 'bg-red-50');
                wrapper.classList.add('border-gray-300', 'hover:border-gray-400', 'has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red');
                const iconPlaceholder = wrapper.querySelector('.feedback-icon-placeholder span');
                if (iconPlaceholder) iconPlaceholder.innerHTML = '';
            });
            quizForm_INTNUM.querySelectorAll('.specific-question-feedback').forEach(el => { el.textContent = ''; el.style.display = 'none'; });
            if (clearGeneralMessage && generalQuizFeedbackDiv_INTNUM) {
                generalQuizFeedbackDiv_INTNUM.textContent = ''; generalQuizFeedbackDiv_INTNUM.style.display = 'none';
                generalQuizFeedbackDiv_INTNUM.className = 'quiz-feedback-message mt-4 p-3 rounded-md text-sm';
            }
        }

        function displayQuizFeedback_INTNUM() {
            if (!quizForm_INTNUM || !generalQuizFeedbackDiv_INTNUM) return;
            const progress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
            const userAnswers = progress.user_quiz_answers || {};
            const submitButton = quizForm_INTNUM.querySelector('button[type="submit"]');
            clearAllVisualFeedback_INTNUM(false);

            if (!progress.quiz_feedback_active && Object.keys(userAnswers).length === 0) {
                quizForm_INTNUM.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
                if (submitButton) { submitButton.textContent = 'Enviar Respuestas'; submitButton.disabled = false; }
                return;
            }
            
            let allCorrect = true, score = 0;
            for (const questionName in quizDataIntegracionNumerica) {
                const userAnswer = userAnswers[questionName], questionData = quizDataIntegracionNumerica[questionName], correctAnswer = questionData.correctAnswer;
                const specificFeedbackDiv = document.getElementById(`${questionName}-specific-feedback`);
                quizForm_INTNUM.querySelectorAll(`input[name="${questionName}"]`).forEach(input => {
                    const wrapper = input.closest('.quiz-option-wrapper'), iconPlaceholder = wrapper.querySelector('.feedback-icon-placeholder span');
                    input.disabled = true;
                    wrapper.classList.remove('has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red');
                    if (input.value === userAnswer) {
                        input.checked = true;
                        if (userAnswer === correctAnswer) {
                            wrapper.classList.add('correct-answer-intnum', 'border-green-500', 'ring-1', 'ring-green-500', 'bg-green-50');
                            if (iconPlaceholder) iconPlaceholder.textContent = ICON_CORRECT_ANSWER_INTNUM; score++;
                        } else {
                            wrapper.classList.add('incorrect-answer-intnum', 'border-red-500', 'ring-1', 'ring-red-500', 'bg-red-50');
                            if (iconPlaceholder) iconPlaceholder.textContent = ICON_INCORRECT_ANSWER_INTNUM; allCorrect = false;
                            if (specificFeedbackDiv && questionData.feedback && questionData.feedback[userAnswer]) {
                                specificFeedbackDiv.textContent = "Incorrecto. " + questionData.feedback[userAnswer]; specificFeedbackDiv.style.display = 'block';
                            } else if (specificFeedbackDiv) { specificFeedbackDiv.textContent = "Respuesta incorrecta."; specificFeedbackDiv.style.display = 'block'; }
                        }
                    } else if (input.value === correctAnswer) {
                         wrapper.classList.add('correct-answer-intnum', 'border-green-500', 'bg-green-50');
                         if (userAnswer !== correctAnswer && iconPlaceholder) iconPlaceholder.textContent = ICON_THUMB_UP_INTNUM;
                    } else { wrapper.classList.add('border-gray-300'); }
                });
            }
            progress.quiz_current_score = score; savePageProgressToStorage_INTNUM(PAGE_KEY_INTNUM, progress);
            generalQuizFeedbackDiv_INTNUM.style.display = 'block';
            if (allCorrect) {
                generalQuizFeedbackDiv_INTNUM.className = 'mt-4 p-3 rounded-md text-sm bg-green-100 text-green-700 border border-green-200';
                generalQuizFeedbackDiv_INTNUM.innerHTML = `<strong>¡Felicidades!</strong> Todas tus respuestas son correctas. (${score}/${Object.keys(quizDataIntegracionNumerica).length})`;
                if (submitButton) { submitButton.textContent = 'Cuestionario Aprobado'; submitButton.disabled = true; }
                updateTaskStatusInStorage_INTNUM(TASKS_INTNUM.QUIZ_PASSED, true);
            } else {
                generalQuizFeedbackDiv_INTNUM.className = 'mt-4 p-3 rounded-md text-sm bg-red-100 text-red-700 border border-red-200';
                generalQuizFeedbackDiv_INTNUM.innerHTML = `Has respondido correctamente ${score} de ${Object.keys(quizDataIntegracionNumerica).length} preguntas. Revisa los comentarios e intenta de nuevo.`;
                if (submitButton) { submitButton.textContent = 'Intentar de Nuevo'; submitButton.disabled = false; }
                updateTaskStatusInStorage_INTNUM(TASKS_INTNUM.QUIZ_PASSED, false);
            }
            if (window.MathJax && window.MathJax.typesetPromise && quizForm_INTNUM) {
                window.MathJax.typesetPromise([quizForm_INTNUM]).catch(err => console.error('Error al reprocesar MathJax en el cuestionario:', err));
            }
        }
        
        async function initializePyodide_INTNUM() {
            if (!window.pyodideInstance_INTNUM_Global) {
                if (codeOutput_INTNUM) codeOutput_INTNUM.innerHTML = "<p>Cargando Pyodide y entorno...</p>";
                try {
                    console.log("[INTNUM] Iniciando carga de Pyodide...");
                    window.pyodideInstance_INTNUM_Global = await window.loadPyodide({});
                    console.log("[INTNUM] loadPyodide() completado.");
                    await window.pyodideInstance_INTNUM_Global.loadPackage("micropip");
                    console.log("[INTNUM] Paquete micropip cargado.");
                    window.pyodideInstance_INTNUM_Global.globals.set("js_iteration_data_intnum", window.pyodideInstance_INTNUM_Global.toPy([]));
                    window.pyodideInstance_INTNUM_Global.globals.set("pyodide_html_output", "");
                    console.log("[INTNUM] Globales de Pyodide configurados.");
                    if (codeOutput_INTNUM) codeOutput_INTNUM.innerHTML = "<p>Pyodide listo. Presiona 'Ejecutar Código'.</p>";
                    if (runCodeButton_INTNUM) runCodeButton_INTNUM.disabled = false;
                } catch (error) {
                    console.error("[INTNUM] Error al cargar/configurar Pyodide:", error);
                    if (codeOutput_INTNUM) codeOutput_INTNUM.innerHTML = `<p style="color:red;">Error al cargar Pyodide: ${error.message}</p>`;
                    if (runCodeButton_INTNUM) runCodeButton_INTNUM.disabled = true;
                    window.pyodideInstance_INTNUM_Global = null; 
                    return null;
                }
            } else {
                 console.log("[INTNUM] Pyodide ya estaba cargado.");
                 if (runCodeButton_INTNUM) runCodeButton_INTNUM.disabled = false;
            }
            return window.pyodideInstance_INTNUM_Global;
        }

        async function runCodeNow_INTNUM() {
            pyodide_INTNUM = await initializePyodide_INTNUM();
            if (!pyodide_INTNUM) { if (codeOutput_INTNUM) codeOutput_INTNUM.innerHTML = "<p>Pyodide no está listo.</p>"; return; }
            if (!codeInput_INTNUM || !codeOutput_INTNUM) return;

            const pythonCode = codeInput_INTNUM.value;
            if (codeOutput_INTNUM) codeOutput_INTNUM.innerHTML = "<p>Ejecutando código...</p>";
            if (chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.textContent = "Generando datos para la gráfica...";
            if (chartCanvas_INTNUM) chartCanvas_INTNUM.style.display = 'none';

            try {
                pyodide_INTNUM.globals.set("pyodide_html_output", "");
                pyodide_INTNUM.runPython("if 'js_iteration_data_intnum' in globals(): js_iteration_data_intnum.clear()");
                pyodide_INTNUM.setStdout({}); pyodide_INTNUM.setStderr({});
                await pyodide_INTNUM.loadPackagesFromImports(pythonCode);
                await pyodide_INTNUM.runPythonAsync(pythonCode); 
                
                const htmlResult = pyodide_INTNUM.globals.get("pyodide_html_output");
                if (codeOutput_INTNUM) codeOutput_INTNUM.innerHTML = htmlResult || "<p>Ejecución completada. No se generó salida HTML.</p>";
                
                const iterationDataJS_INTNUM = pyodide_INTNUM.globals.get("js_iteration_data_intnum").toJs({ dict_converter: Object.fromEntries });
                updateTaskStatusInStorage_INTNUM(TASKS_INTNUM.RUN_CODE, true);

                if (chartCanvas_INTNUM) {
                    if (iterationDataJS_INTNUM && iterationDataJS_INTNUM.length > 0) {
                        await drawChartJsGraph_INTNUM(iterationDataJS_INTNUM);
                        if (chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.style.display = 'none';
                        chartCanvas_INTNUM.style.display = 'block';
                    } else {
                        if (chartLoadingMessage_INTNUM) {
                             chartLoadingMessage_INTNUM.textContent = "No se generaron datos suficientes para la gráfica.";
                             chartLoadingMessage_INTNUM.style.display = 'block';
                        }
                        if (methodChart_INTNUM && typeof methodChart_INTNUM.destroy === 'function') methodChart_INTNUM.destroy();
                    }
                }
            } catch (error) { 
                if (codeOutput_INTNUM) codeOutput_INTNUM.innerHTML = `<p style="color:red;">Error en la ejecución: ${error.message || String(error)}</p>`;
                if (chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.textContent = "Error al generar datos para la gráfica.";
                console.error("Error en runCodeNow_INTNUM:", error);
            } finally {
                pyodide_INTNUM.setStdout({}); pyodide_INTNUM.setStderr({});
            }
        }

        async function drawChartJsGraph_INTNUM(graphDataFromPyodide) {
            if (!pyodide_INTNUM) { if(chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.textContent = 'Pyodide no listo.'; return; }
            if (!chartCanvas_INTNUM) { console.error("Elemento Canvas no encontrado para la gráfica de Integración Numérica."); return; }
            
            if(chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.textContent = 'Generando gráfica de Integración Numérica...';

            try {
                const funcPlotData = graphDataFromPyodide.find(d => d.type === 'function_plot');
                const paramsData = graphDataFromPyodide.find(d => d.type === 'integration_params');

                if (!funcPlotData || !paramsData) {
                    if(chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.textContent = "Datos insuficientes para la gráfica.";
                    return;
                }

                if (methodChart_INTNUM && typeof methodChart_INTNUM.destroy === 'function') methodChart_INTNUM.destroy();
                const ctx_intnum = chartCanvas_INTNUM.getContext('2d');
                
                const datasets_intnum = [];

                // 1. Plot f(x)
                if (funcPlotData.x_values && funcPlotData.y_values && funcPlotData.x_values.length === funcPlotData.y_values.length) {
                    datasets_intnum.push({
                        label: 'f(x)',
                        data: funcPlotData.x_values.map((val, index) => ({x: val, y: funcPlotData.y_values[index]})),
                        borderColor: 'rgb(54, 162, 235)', borderWidth: 2, fill: false, tension: 0.1, type: 'line',
                        pointRadius: 0
                    });
                }

                // 2. Plot points used by one of the methods and fill area
                if (paramsData.points_data && paramsData.points_data.length > 0) {
                    const pointsToPlot = paramsData.points_data[0]; 
                    if (pointsToPlot.x_points && pointsToPlot.y_points) {
                         datasets_intnum.push({
                            label: `Puntos ${pointsToPlot.method} (n=${pointsToPlot.n_segments})`,
                            data: pointsToPlot.x_points.map((xp, idx) => ({x: xp, y: pointsToPlot.y_points[idx]})),
                            backgroundColor: 'rgb(255, 99, 132)',
                            pointRadius: 4,
                            showLine: false, 
                            type: 'scatter'
                        });
                        
                        const fillData = funcPlotData.x_values
                            .map((x, i) => ({x: x, y: funcPlotData.y_values[i]}))
                            .filter(p => p.x >= paramsData.a && p.x <= paramsData.b);
                        
                        if(fillData.length > 0) {
                            // Ensure the fill starts and ends exactly at a and b
                            // by adding these points if they are not already the first/last
                            // and their y-values by evaluating the function.
                            let finalFillData = [];
                            const pyFunc = pyodide_INTNUM.globals.get('func_to_integrate');

                            if (fillData[0].x > paramsData.a) {
                                finalFillData.push({ x: paramsData.a, y: pyFunc(paramsData.a) });
                            }
                            finalFillData.push(...fillData);
                            if (finalFillData[finalFillData.length-1].x < paramsData.b) {
                                finalFillData.push({ x: paramsData.b, y: pyFunc(paramsData.b) });
                            }
                             // Sort by x just in case
                            finalFillData.sort((ptA, ptB) => ptA.x - ptB.x);


                            datasets_intnum.push({
                                label: 'Área Integrada (Aprox.)',
                                data: finalFillData,
                                backgroundColor: 'rgba(75, 192, 192, 0.3)', 
                                borderColor: 'rgba(75, 192, 192, 0.5)',
                                borderWidth: 1,
                                fill: 'origin', 
                                type: 'line', 
                                pointRadius: 0,
                                order: -1 
                            });
                        }
                    }
                }
                
                methodChart_INTNUM = new Chart(ctx_intnum, {
                    type: 'scatter', 
                    data: { datasets: datasets_intnum },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { 
                            x: { title: { display: true, text: 'x' } }, 
                            y: { title: { display: true, text: 'f(x)' } } 
                        },
                        plugins: { 
                            legend: { position: 'top' }, 
                            title: { display: true, text: "Visualización de Integración Numérica", font: {size: 16} },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += `(x: ${context.parsed.x.toFixed(4)}, y: ${context.parsed.y.toFixed(4)})`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
                if(chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.style.display = 'none';
            } catch (error) { 
                if(chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.textContent = `Error al generar gráfica: ${error.message || String(error)}`; 
                console.error("Error en drawChartJsGraph_INTNUM:", error); 
            }
        }

        // --- Event Listeners y Lógica de Inicialización ---
        if (runCodeButton_INTNUM) runCodeButton_INTNUM.addEventListener('click', runCodeNow_INTNUM);

        if (quizForm_INTNUM) {
            quizForm_INTNUM.addEventListener('submit', function(event) {
                event.preventDefault();
                const currentLocalProgress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
                const submitButton = quizForm_INTNUM.querySelector('button[type="submit"]');
                if (currentLocalProgress[TASKS_INTNUM.QUIZ_PASSED] && submitButton.textContent !== 'Intentar de Nuevo') return;

                if (submitButton && submitButton.textContent === 'Intentar de Nuevo') {
                    quizForm_INTNUM.reset(); clearAllVisualFeedback_INTNUM(true); 
                    if(generalQuizFeedbackDiv_INTNUM) generalQuizFeedbackDiv_INTNUM.style.display = 'none';
                    let progressToSave = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
                    progressToSave.user_quiz_answers = {}; progressToSave.quiz_current_score = 0; progressToSave.quiz_feedback_active = false; 
                    savePageProgressToStorage_INTNUM(PAGE_KEY_INTNUM, progressToSave);
                    updateTaskStatusInStorage_INTNUM(TASKS_INTNUM.QUIZ_PASSED, false); 
                    quizForm_INTNUM.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
                    quizForm_INTNUM.querySelectorAll('.quiz-option-wrapper').forEach(wrapper => {
                         wrapper.classList.add('has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red');
                    });
                    submitButton.textContent = 'Enviar Respuestas'; return;
                }

                const formData = new FormData(quizForm_INTNUM);
                let allAnswered = Object.keys(quizDataIntegracionNumerica).every(qName => formData.get(qName) !== null);
                if (!allAnswered) {
                    if (generalQuizFeedbackDiv_INTNUM) {
                        generalQuizFeedbackDiv_INTNUM.textContent = "Por favor, responde todas las preguntas.";
                        generalQuizFeedbackDiv_INTNUM.className = 'mt-4 p-3 rounded-md text-sm bg-yellow-100 text-yellow-700 border border-yellow-200';
                        generalQuizFeedbackDiv_INTNUM.style.display = 'block';
                    } return;
                }
                updateTaskStatusInStorage_INTNUM(TASKS_INTNUM.QUIZ_ATTEMPTED, true);
                let progress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
                progress.user_quiz_answers = {};
                for (const qName of Object.keys(quizDataIntegracionNumerica)) progress.user_quiz_answers[qName] = formData.get(qName);
                progress.quiz_feedback_active = true; 
                savePageProgressToStorage_INTNUM(PAGE_KEY_INTNUM, progress);
                displayQuizFeedback_INTNUM();
            });
        }

        if (mainCompletionButton_INTNUM) {
            mainCompletionButton_INTNUM.addEventListener('click', () => {
                const progress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
                let markAllAs = !ALL_TASK_KEYS_INTNUM.every(taskKey => progress[taskKey] === true);
                ALL_TASK_KEYS_INTNUM.forEach(taskName => updateTaskStatusInStorage_INTNUM(taskName, markAllAs));
                let updatedProgress = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
                if (!markAllAs) {
                    updatedProgress.user_quiz_answers = {}; updatedProgress.quiz_current_score = 0; updatedProgress.quiz_feedback_active = false;
                    if (quizForm_INTNUM) {
                        quizForm_INTNUM.reset(); quizForm_INTNUM.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
                        const sb = quizForm_INTNUM.querySelector('button[type="submit"]'); if(sb) sb.textContent = 'Enviar Respuestas';
                         quizForm_INTNUM.querySelectorAll('.quiz-option-wrapper').forEach(wrapper => {
                            wrapper.classList.add('has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red');
                        });
                    } clearAllVisualFeedback_INTNUM(true);
                } else {
                     updatedProgress[TASKS_INTNUM.QUIZ_ATTEMPTED] = true; updatedProgress[TASKS_INTNUM.QUIZ_PASSED] = true;
                    if (Object.keys(updatedProgress.user_quiz_answers).length === 0) {
                        for (const qName in quizDataIntegracionNumerica) updatedProgress.user_quiz_answers[qName] = quizDataIntegracionNumerica[qName].correctAnswer;
                        updatedProgress.quiz_current_score = Object.keys(quizDataIntegracionNumerica).length;
                    } updatedProgress.quiz_feedback_active = true;
                }
                savePageProgressToStorage_INTNUM(PAGE_KEY_INTNUM, updatedProgress);
                if (quizForm_INTNUM) displayQuizFeedback_INTNUM();
                calculateAndUpdateOverallProgress_INTNUM();
                if (generalQuizFeedbackDiv_INTNUM && !markAllAs) generalQuizFeedbackDiv_INTNUM.style.display = 'none';
                alert(markAllAs ? 'Todas las tareas marcadas como completadas.' : 'Se ha deshecho el completado de todas las tareas.');
            });
        }

        const theorySectionObserverTargetNode_INTNUM = document.getElementById('conclusion-metodo') || document.getElementById('teoria');
        if (theorySectionObserverTargetNode_INTNUM) {
            const observerCallback = (entries) => entries.forEach(entry => {
                if (entry.isIntersecting && !getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM)[TASKS_INTNUM.READ_THEORY]) {
                    updateTaskStatusInStorage_INTNUM(TASKS_INTNUM.READ_THEORY, true);
                }
            });
            new IntersectionObserver(observerCallback, { root: null, rootMargin: '0px', threshold: 0.1 }).observe(theorySectionObserverTargetNode_INTNUM);
        }
        
        if (window.location.hash) history.replaceState(null, '', window.location.pathname + window.location.search);
        
        (async () => { 
            pyodide_INTNUM = await initializePyodide_INTNUM();
            if (pyodide_INTNUM && chartCanvas_INTNUM && codeInput_INTNUM && codeInput_INTNUM.value.trim() !== "") {
                if (chartLoadingMessage_INTNUM) chartLoadingMessage_INTNUM.textContent = "Ejecute el código para generar los datos de la gráfica.";
            } else if (chartCanvas_INTNUM && chartLoadingMessage_INTNUM) {
                 chartLoadingMessage_INTNUM.textContent = "Proporcione y ejecute el código para generar la gráfica.";
            }
            if (pyodide_INTNUM && runCodeButton_INTNUM) runCodeButton_INTNUM.disabled = false;
            else if (runCodeButton_INTNUM) runCodeButton_INTNUM.disabled = true;
        })();

        const initialProgress_INTNUM = getPageProgressFromStorage_INTNUM(PAGE_KEY_INTNUM);
        if (initialProgress_INTNUM.quiz_feedback_active || (initialProgress_INTNUM[TASKS_INTNUM.QUIZ_ATTEMPTED] && Object.keys(initialProgress_INTNUM.user_quiz_answers).length > 0) ) {
            if (quizForm_INTNUM && initialProgress_INTNUM.user_quiz_answers) {
                 for (const qName in initialProgress_INTNUM.user_quiz_answers) {
                    const userAnswer = initialProgress_INTNUM.user_quiz_answers[qName];
                    const escapedUserAnswer = userAnswer.replace(/([\\()\[\]"'])/g, '\\$1');
                    try {
                        const radioToSelect = quizForm_INTNUM.querySelector(`input[name="${qName}"][value="${escapedUserAnswer}"]`);
                        if (radioToSelect) radioToSelect.checked = true;
                    } catch (e) { console.warn(`Error al seleccionar radio para ${qName}:`, e); }
                }
            } displayQuizFeedback_INTNUM(); 
        } else if (quizForm_INTNUM) {
            const sb = quizForm_INTNUM.querySelector('button[type="submit"]'); if (sb) { sb.textContent = 'Enviar Respuestas'; sb.disabled = false; }
            quizForm_INTNUM.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = false);
            quizForm_INTNUM.querySelectorAll('.quiz-option-wrapper').forEach(wrapper => {
                wrapper.classList.add('has-[:checked]:bg-red-50', 'has-[:checked]:border-custom-red', 'has-[:checked]:ring-1', 'has-[:checked]:ring-custom-red');
            });
            if (window.MathJax && window.MathJax.typesetPromise && quizForm_INTNUM) {
                window.MathJax.typesetPromise([quizForm_INTNUM]).catch(err => console.error('Error MathJax inicial:', err));
            }
        }
        calculateAndUpdateOverallProgress_INTNUM();
    });
    </script>
    <!-- END INTNUM SCRIPT -->

<script type="module">
    const { createApp, ref, onMounted, onUnmounted, watch, nextTick } = Vue;

    const LeftSidebar = { // Definición del componente LeftSidebar para Vue
        props: {
            pageThemeColor: { type: String, default: 'red' }, // Color base del tema (e.g., 'red', 'blue')
            pageGradientFrom: { type: String, default: 'from-red-500' }, // Clase para inicio de gradiente
            pageGradientTo: { type: String, default: 'to-red-700' },     // Clase para fin de gradiente
            pageActiveTextColor: { type: String, default: 'text-custom-red' } // Texto activo para links, usa el color base
        },
        template: `{% raw %}
            <aside 
                :class="[
                    'bg-gradient-to-b', pageGradientFrom, pageGradientTo,
                    'shadow-xl', 'rounded-lg', 'p-4',
                    'flex', 'flex-col',
                    'transition-all', 'duration-300', 'ease-in-out',
                    'order-1', 
                    isCollapsed ? 'w-full lg:w-20' : 'w-full lg:w-64',
                    'self-start', 
                    'lg:sticky', 'lg:top-8', 
                    'lg:max-h-[calc(100vh-4rem)]', // Altura máxima considerando 2rem (top-8) * 2 para arriba y abajo
                    'overflow-y-auto' // Scroll si el contenido excede la altura máxima
                ]"
                aria-label="Sidebar de navegación del método">
                <div :class="['flex justify-between items-center mb-4 border-b pb-3', 'border-' + pageThemeColor + '-400']">
                    <h3 v-show="!isCollapsed" class="text-lg font-semibold text-white select-none">Contenido</h3>
                    <button @click="toggleCollapse" :class="['p-1.5 ml-2 text-white rounded focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-75', 'hover:bg-' + pageThemeColor + '-600']" :aria-label="isCollapsed ? 'Expandir menú' : 'Colapsar menú'">
                        <svg v-if="!isCollapsed" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18.75 19.5l-7.5-7.5 7.5-7.5m-6 15L5.25 12l7.5-7.5" />
                        </svg>
                        <svg v-else xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" />
                        </svg>
                    </button>
                </div>
                <nav v-show="!isCollapsed" class="flex-grow">
                    <ul class="space-y-1">
                        <li v-for="item in navItems" :key="item.id">
                            <a :href="item.href"
                               @click.prevent="smoothScroll(item.href)"
                               :class="[
                                   'nav-link block px-4 py-2 rounded-md text-sm font-medium transition-colors duration-150 flex items-center',
                                   isActive(item.id) ? ['bg-white shadow-sm font-semibold', pageActiveTextColor] : ['text-' + pageThemeColor + '-100', 'hover:text-white', 'hover:bg-' + pageThemeColor + '-600']
                               ]">
                                <span v-html="item.iconSVG" class="mr-3 translate-y-px"></span>
                                <span>{{ item.text }}</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                <nav v-show="isCollapsed" class="mt-4 flex-grow">
                     <ul class="space-y-1">
                        <li v-for="item in navItems" :key="item.id + '-collapsed'">
                            <a :href="item.href"
                               @click.prevent="smoothScroll(item.href)"
                               :title="item.text"
                               :aria-label="item.text"
                               :class="[
                                   'nav-link-collapsed block py-2 pl-2.5 pr-1.5 rounded-md transition-colors duration-150 flex justify-center items-center',
                                   isActive(item.id) ? ['bg-white shadow-sm', pageActiveTextColor] : ['text-' + pageThemeColor + '-100', 'hover:text-white', 'hover:bg-' + pageThemeColor + '-600']
                               ]">
                                <span v-html="item.iconSVG" class="w-6 h-6 translate-y-px"></span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>
        {% endraw %}`,
        setup(props) {
            const isCollapsed = ref(false);
            const activeSectionId = ref(null);
            // navItems se define aquí o se pasa como prop si varía mucho entre páginas
            const navItems = ref([
                { id: 'teoria', text: 'Fundamento Teórico', href: '#teoria', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>' },
                { id: 'algoritmo', text: 'Pasos del Algoritmo', href: '#algoritmo', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>' },
                { id: 'ejemplo', text: 'Ejemplo Detallado', href: '#ejemplo', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>' },
                { id: 'codigo', text: 'Implementación (Python)', href: '#codigo', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" /></svg>' },
                { id: 'graficas', text: 'Gráficas Interactivas', href: '#graficas', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>' },
                { id: 'videos', text: 'Videos Explicativos', href: '#videos', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.75.75 0 010 1.656l-5.603 3.113A.75.75 0 019 15.95V9.05a.75.75 0 011.307-.588l5.603 3.112z" /></svg>' },
                { id: 'conclusion-metodo', text: 'Conclusión y Aplicaciones', href: '#conclusion-metodo', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>' },
                { id: 'referencias', text: 'Referencias', href: '#referencias', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25L7.5 16.5V3.75m9 0H18A2.25 2.25 0 0120.25 6v12A2.25 2.25 0 0118 20.25H6A2.25 2.25 0 013.75 18V6A2.25 2.25 0 016 3.75h1.5m9 0h-9" /></svg>' },
                { id: 'cuestionario', text: 'Cuestionario', href: '#cuestionario', iconSVG: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>' }
            ]); // Asegúrate de que estos navItems sean los correctos para todas las páginas o ajústalos.

            let sections = []; // Para el scroll-spy

            const toggleCollapse = () => {
                isCollapsed.value = !isCollapsed.value;
            };

            const isActive = (id) => {
                return activeSectionId.value === id;
            };
            
            const smoothScroll = (targetHref) => {
                const targetId = targetHref.substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: "smooth", block: "start" });
                    history.pushState(null, null, targetHref); 
                }
            };

            const handleScroll = () => {
                if (!sections || sections.length === 0) return;
                const scrollMarginTopValue = parseInt(getComputedStyle(sections[0]).scrollMarginTop) || 96; 
                let newActiveSectionId = null;
                for (let i = 0; i < sections.length; i++) {
                    const section = sections[i];
                    const sectionTopBoundary = section.offsetTop - scrollMarginTopValue;
                    const sectionBottomBoundary = sectionTopBoundary + section.offsetHeight;
                    if (window.scrollY >= sectionTopBoundary && window.scrollY < sectionBottomBoundary) {
                        newActiveSectionId = section.id;
                        break;
                    }
                }
                if (newActiveSectionId === null && sections.length > 0) {
                    for (let i = sections.length - 1; i >= 0; i--) {
                        const section = sections[i];
                        if ((section.offsetTop - scrollMarginTopValue) <= window.scrollY + 5) {
                            newActiveSectionId = section.id;
                            break;
                        }
                    }
                }
                 if (newActiveSectionId === null && sections.length > 0 && window.scrollY < (sections[0].offsetTop - scrollMarginTopValue)) {
                    newActiveSectionId = sections[0].id;
                 }
                if (activeSectionId.value !== newActiveSectionId) {
                    activeSectionId.value = newActiveSectionId;
                }
            };

            onMounted(() => {
                nextTick(() => {
                    sections = Array.from(document.querySelectorAll('main article section[id]'));
                    handleScroll(); 
                    window.addEventListener('scroll', handleScroll, { passive: true });
                });
            });

            onUnmounted(() => {
                window.removeEventListener('scroll', handleScroll);
            });

            return {
                isCollapsed,
                toggleCollapse,
                navItems,
                isActive,
                smoothScroll,
                activeSectionId,
                // pageThemeColor, pageGradientFrom, pageGradientTo, pageActiveTextColor // Expuestas desde props
            };
        }
    };

    const app = createApp({
        components: { LeftSidebar },
        setup() {
            const METHOD_KEY = "integracion-numerica";
            const METHOD_NAME_TITLE_CASE = "Integración Numérica";
            const currentSection = ref('');
            const completedSections = ref({});
            const updateActiveSection = () => { /* ... */ }; // Simplified, main scrollspy in LeftSidebar
            const updateCompletedSectionsForSidebar = () => {
                const progressData = JSON.parse(localStorage.getItem(METHOD_KEY) || '{}');
                const newCompleted = {};
                if (progressData.read_theory) newCompleted.teoria = true;
                if (progressData.run_code) newCompleted.codigo = true;
                if (progressData.quiz_passed) newCompleted.cuestionario = true;
                completedSections.value = newCompleted;
            };
            onMounted(() => {
                updateActiveSection(); window.addEventListener('scroll', updateActiveSection);
                updateCompletedSectionsForSidebar(); window.addEventListener('storage', (e) => { if (e.key === METHOD_KEY) updateCompletedSectionsForSidebar(); });
                const originalSaveFn = window.savePageProgressToStorage_INTNUM; // INTNUM specific
                if (typeof originalSaveFn === 'function') {
                    window.savePageProgressToStorage_INTNUM = function(...args) { originalSaveFn.apply(this, args); updateCompletedSectionsForSidebar(); };
                }
                if (window.MathJax && window.MathJax.typesetPromise) nextTick(() => window.MathJax.typesetPromise());
            });
            onUnmounted(() => window.removeEventListener('scroll', updateActiveSection));
            return { currentSectionProps: currentSection, completedSectionsProps: completedSections, methodKeyProps: METHOD_KEY, methodNameProps: METHOD_NAME_TITLE_CASE };
        }
    });
    app.config.compilerOptions.isCustomElement = tag => tag.startsWith('mjx-');
    app.mount('#app');
</script>
</body>
</html>